# 灯笼叶子消消乐 - 系统设计 V2

---

## 前后端不匹配问题清单

### ❌ 已发现问题

| # | 问题描述 | 前端位置 | 后端位置 | 状态 |
|---|----------|---------|---------|------|
| 1 | **"下一关"按钮不应存在** | `demo/index.html:226` | 无 | ✅ 已删除 |
| 2 | **提示按钮无次数限制** | `demo/index.html:224` hintBtn | `HintSystem.ts` 无限使用 | ❌ 待修复 |
| 3 | **特殊方块只有3种** | `index.html:271-275` | `types.ts:29` | ❌ 待扩展 |
| 4 | **主菜单缺少功能按钮** | `menu.html` 只有2按钮 | 无收藏馆/排行榜/皮肤 | ❌ 待添加 |
| 5 | **无道具系统** | 只有提示按钮 | 无道具数据结构 | ❌ 待实现 |
| 6 | **无广告奖励入口** | 仅体力不足时有 | `EnergyManager.ts` | ❌ 待扩展 |
| 7 | **连消无奖励机制** | 只显示连消文字 | 无奖励逻辑 | ❌ 待实现 |
| 8 | **玩家数据缺少道具/货币** | 无 | `PlayerProgress.ts` | ❌ 待扩展 |

---

## 1. 主菜单功能设计

### 1.1 按钮布局

```
┌─────────────────────────────────────┐
│         场景动画区域                 │
│         (猫狗角色)                   │
├─────────────────────────────────────┤
│         灯笼叶子消消乐               │
│         Lanternleaf Match           │
├─────────────────────────────────────┤
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │
│  │关卡 │ │星数 │ │金币 │ │道具 │   │
│  │ 2   │ │ 45  │ │1200 │ │ 8   │   │
│  └─────┘ └─────┘ └─────┘ └─────┘   │
├─────────────────────────────────────┤
│    ⚡ 5/5 已满     🎬 免费体力       │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │      🎮 开始游戏             │    │ ← 主按钮
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────┐  ┌─────────┐          │
│  │🏆 排行榜 │  │🖼️ 收藏馆 │          │ ← 次要按钮
│  └─────────┘  └─────────┘          │
│                                     │
│  ┌─────────┐  ┌─────────┐          │
│  │🎨 皮肤   │  │🎁 每日奖励│          │
│  └─────────┘  └─────────┘          │
│                                     │
│  ┌─────────┐  ┌─────────┐          │
│  │⚙️ 设置  │  │📢 公告   │          │
│  └─────────┘  └─────────┘          │
└─────────────────────────────────────┘
```

### 1.2 功能说明

| 按钮 | 功能 | 优先级 |
|------|------|--------|
| 开始游戏 | 跳转关卡选择 | P0 |
| 排行榜 | 好友/全服星数排名 | P1 |
| 收藏馆 | 收集的明信片/成就 | P1 |
| 皮肤 | 棋盘/角色皮肤商店 | P2 |
| 每日奖励 | 每日签到+广告奖励 | P0 |
| 设置 | 音效/震动/账号 | P0 |
| 公告 | 游戏公告/活动 | P2 |
| 免费体力 | 看广告获得体力 | P0 |

---

## 2. 道具系统设计（玩家主动使用的工具）

> **注意**：道具 ≠ 特殊方块
> - 道具：玩家主动点击使用的消耗品（提示、重排、锤子等）
> - 特殊方块：棋盘上通过消除自动生成的特效方块

### 2.1 道具类型

| 道具 | 图标 | 效果 | 初始数量 | 获取方式 |
|------|------|------|----------|----------|
| **提示** | 💡 | 高亮一个可消除位置 | 3 | 通关/广告/商店 |
| **重排** | 🔄 | 重新排列所有方块（不移除苔藓） | 2 | 通关/广告/商店 |
| **锤子** | 🔨 | 点击消除任意1个普通方块 | 1 | 广告/商店 |
| **清行** | ↔️ | 点选一行，清除该行所有方块 | 0 | 星级奖励/商店 |
| **清列** | ↕️ | 点选一列，清除该列所有方块 | 0 | 星级奖励/商店 |
| **爆破** | 💣 | 点击位置清除3×3区域 | 0 | 星级奖励/商店 |
| **+3步** | ⏱️ | 当前关卡增加3步（限1次） | - | 广告（关卡内限用） |

### 2.2 道具获取规则

```typescript
interface ItemRewardRule {
  // 通关奖励
  levelClear: {
    hint: 1,      // 每关通关 +1 提示
    shuffle: 0,   // 3星通关 +1 重排
    hammer: 0,    // Boss关通关 +1 锤子
  };

  // 星级里程碑奖励
  starMilestones: {
    15: { rowClear: 1 },   // 15星解锁横扫
    30: { colClear: 1 },   // 30星解锁竖扫
    50: { bomb: 1 },       // 50星解锁炸弹
    75: { hint: 3, shuffle: 2 },
    100: { hammer: 2, bomb: 1 },
    // ... 每25星一个里程碑
  };

  // 广告奖励
  adReward: {
    hint: 2,      // 看一次广告 +2 提示
    shuffle: 1,   // 看一次广告 +1 重排
    extraMoves: 3, // 关卡内看广告 +3 步（每关限1次）
  };

  // 每日登录奖励
  dailyLogin: [
    { day: 1, reward: { hint: 2 } },
    { day: 2, reward: { shuffle: 1 } },
    { day: 3, reward: { hammer: 1 } },
    { day: 4, reward: { hint: 3 } },
    { day: 5, reward: { shuffle: 2 } },
    { day: 6, reward: { hint: 2, hammer: 1 } },
    { day: 7, reward: { bomb: 1, rowClear: 1, colClear: 1 } },
  ];
}
```

### 2.3 道具使用限制

| 道具 | 每关限制 | 冷却时间 | 特殊限制 |
|------|----------|----------|----------|
| 提示 | 无限制 | 3秒 | 无 |
| 重排 | 2次 | 5秒 | 无 |
| 锤子 | 3次 | 无 | 不能消特殊块 |
| 横扫 | 1次 | 无 | 无 |
| 竖扫 | 1次 | 无 | 无 |
| 炸弹 | 1次 | 无 | 无 |
| +3步 | 1次 | 无 | 仅关卡内广告 |

### 2.4 数据结构

```typescript
interface PlayerInventory {
  items: {
    hint: number;       // 提示数量
    shuffle: number;    // 重排数量
    hammer: number;     // 锤子数量
    rowClear: number;   // 横扫数量
    colClear: number;   // 竖扫数量
    bomb: number;       // 炸弹数量
  };

  // 解锁状态
  unlockedItems: Set<ItemType>;

  // 里程碑领取记录
  claimedMilestones: number[];

  // 每日登录
  dailyLogin: {
    lastLoginDate: string;  // YYYY-MM-DD
    consecutiveDays: number;
    claimedToday: boolean;
  };
}
```

---

## 3. 特殊方块系统设计（棋盘上通过消除生成）

> **特殊方块**：通过消除自动生成在棋盘上的特效方块
> - 由消除动作触发生成（4连、5连、T型、L型等）
> - 或由连消奖励机制生成
> - 或随机出现在新填充的方块中

### 3.1 现有特殊块（保留）

| 类型 | 图标 | 生成条件 | 效果 |
|------|------|----------|------|
| `whirl_h` | 🌀↔️ | 水平4连 | 消除时清除整行 |
| `whirl_v` | 🌀↕️ | 垂直4连 | 消除时清除整列 |
| `lantern` | 🏮 | 5连 | 消除时清除周围3×3 |

### 3.2 新增特殊块

| 类型 | 图标 | 生成条件 | 效果 |
|------|------|----------|------|
| `rainbow` | 🌈 | T型/L型消除 | 点击选择颜色，消除全部该色方块 |
| `wildcard` | 🃏 | 连消≥4次奖励 | 可与任意颜色匹配消除 |
| `multiplier` | ×2 | 随机出现（2%概率） | 该方块被消除时收集数×2 |
| `frozen` | ❄️ | 随机出现（1%概率） | 需消除2次才能清除（类似冰块） |
| `bomb_timer` | 💣5 | 高难度关卡出现 | 5步内必须消除否则游戏失败 |

### 3.3 连消奖励机制（自动生成特殊块）

| 连消次数 | 奖励效果 |
|----------|----------|
| 2连消 | 无 |
| 3连消 | 随机生成1个 `multiplier` (×2方块) |
| 4连消 | 随机生成1个 `wildcard` (百搭方块) |
| 5连消+ | 随机生成1个 `rainbow` (彩虹方块) |

### 3.4 随机出现的特殊块

在填充新方块时有概率生成特殊块：

| 方块类型 | 出现概率 | 关卡限制 |
|----------|----------|----------|
| `multiplier` | 2% | 11关起 |
| `wildcard` | 1% | 21关起 |
| `frozen` | 1.5% | 16关起 |
| `bomb_timer` | 0.5% | 31关起（Boss关更高） |

### 3.4 特殊块组合效果

| 组合 | 效果 |
|------|------|
| `whirl_h` + `whirl_v` | 清除十字（整行+整列） |
| `whirl` + `lantern` | 清除3行或3列 |
| `lantern` + `lantern` | 清除5×5区域 |
| `rainbow` + 任意 | 将所有同色变为该特殊块并触发 |

### 3.5 类型定义更新

```typescript
// 扩展 SpecialType
export type SpecialType =
  | 'whirl_h'
  | 'whirl_v'
  | 'lantern'
  | 'rainbow'      // 新增：彩虹块
  | 'freezer'      // 新增：冰冻块
  | 'multiplier'   // 新增：倍数块
  | 'wildcard';    // 新增：百搭块

// 方块状态
export interface Tile {
  type: TileType;
  isSpecial: boolean;
  specialType?: SpecialType;
  frozen?: number;       // 冰冻剩余步数
  multiplier?: number;   // 倍数（默认1）
  isWildcard?: boolean;  // 是否百搭
}
```

---

## 4. 广告系统设计

### 4.1 广告入口

| 入口 | 位置 | 奖励 | 每日限制 |
|------|------|------|----------|
| 免费体力 | 主菜单 | +1体力 | 6次/小时 |
| 每日奖励 | 签到页 | 额外道具 | 1次/天 |
| 续命 | 关卡内失败 | +3步继续 | 1次/关 |
| 道具商店 | 道具页 | +2提示/+1重排 | 各3次/天 |
| 双倍奖励 | 通关结算 | 金币×2 | 无限制 |

### 4.2 广告按钮设计

```html
<!-- 主菜单免费体力按钮 -->
<button class="btn btn-ad" id="freeEnergyBtn">
  🎬 免费体力
  <span class="ad-count">剩余 6 次</span>
</button>

<!-- 每日奖励广告 -->
<button class="btn btn-ad-bonus" id="dailyAdBtn">
  📺 看广告领双倍
</button>
```

---

## 5. 收藏馆设计

### 5.1 收藏内容

| 类型 | 获取方式 | 数量 |
|------|----------|------|
| 明信片 | 每10关解锁1张 | 5张 |
| 成就徽章 | 达成特定条件 | 20个 |
| 故事章节 | 按进度解锁 | 5章 |

### 5.2 成就列表

| 成就 | 条件 | 奖励 |
|------|------|------|
| 初出茅庐 | 通关第1关 | 💡×3 |
| 崭露头角 | 通关第10关 | 🔄×2 |
| 小有所成 | 收集100星 | 🔨×2 |
| 连消大师 | 单次5连消 | 💣×1 |
| 完美通关 | 3星通关10关 | 🎨皮肤碎片 |
| ... | ... | ... |

---

## 6. 排行榜设计

### 6.1 榜单类型

| 榜单 | 排序依据 | 刷新周期 |
|------|----------|----------|
| 总星榜 | 总星数 | 永久 |
| 周星榜 | 本周获得星数 | 每周一重置 |
| 关卡榜 | 当前关卡数 | 永久 |
| 好友榜 | 好友星数 | 实时 |

### 6.2 排行奖励

| 排名 | 周榜奖励 |
|------|----------|
| 第1名 | 💣×3, 🔨×5, 金币×1000 |
| 第2-3名 | 💣×2, 🔨×3, 金币×500 |
| 第4-10名 | 🔨×2, 💡×5, 金币×200 |
| 第11-50名 | 💡×3, 金币×100 |

---

## 7. 皮肤系统设计

### 7.1 皮肤类型

| 类型 | 说明 | 解锁方式 |
|------|------|----------|
| 棋盘背景 | 游戏区域背景 | 星级/购买 |
| 方块样式 | 5种基础方块外观 | 收集碎片 |
| 角色皮肤 | 猫狗换装 | 活动/购买 |
| 特效皮肤 | 消除特效 | 成就/购买 |

### 7.2 皮肤碎片

- 每种皮肤需要 10 个碎片解锁
- 碎片获取：3星通关、成就、每日签到、活动

---

## 8. 数据结构汇总

### 8.1 完整玩家数据

```typescript
interface PlayerData {
  // 基础信息
  playerId: string;
  nickname: string;
  avatar: string;
  createTime: number;

  // 关卡进度
  progress: {
    currentLevel: number;
    levelStars: Record<number, number>;
    totalStars: number;
    completedLevels: number;
  };

  // 道具库存
  inventory: {
    hint: number;
    shuffle: number;
    hammer: number;
    rowClear: number;
    colClear: number;
    bomb: number;
  };

  // 货币
  currency: {
    coins: number;       // 金币（免费）
    gems: number;        // 钻石（付费）
  };

  // 体力
  energy: {
    current: number;
    max: number;
    lastRegenTime: number;
  };

  // 每日数据（每日重置）
  daily: {
    date: string;
    loginRewardClaimed: boolean;
    consecutiveLoginDays: number;
    adWatchCount: {
      energy: number;
      items: number;
      doubleReward: number;
    };
    levelExtraMovesUsed: Set<number>;
  };

  // 收藏
  collection: {
    postcards: number[];      // 已解锁明信片ID
    achievements: string[];   // 已达成成就ID
    skins: string[];          // 已解锁皮肤ID
    skinFragments: Record<string, number>;
  };

  // 设置
  settings: {
    bgmVolume: number;
    sfxVolume: number;
    vibration: boolean;
    language: string;
  };

  // 统计
  stats: {
    totalPlayTime: number;
    totalMatches: number;
    maxCombo: number;
    totalCoinsEarned: number;
  };
}
```

---

## 9. 实施优先级

### P0 - 必须实现

1. ✅ 删除"下一关"按钮
2. 道具系统（提示/重排/锤子）
3. 道具使用次数限制
4. 主菜单广告按钮
5. 每日签到奖励

### P1 - 建议实现

1. 星级里程碑奖励
2. 连消奖励砖块
3. 排行榜（简化版）
4. 收藏馆（成就）

### P2 - 后续迭代

1. 皮肤系统
2. 彩虹块等高级特殊块
3. 好友系统
4. 周榜奖励
