# Design: Core UI Pages

## Context

### 背景
- 项目使用 Cocos Creator 3.8 开发
- 目前有 Menu.scene 和 Game.scene 两个空场景
- 已有 UI 组件：HudView、ModalManager、各类弹窗
- 设计分辨率 1080×1920 竖屏

### 约束
- 必须支持竖屏布局
- 需要与现有体力系统集成
- 需要持久化存储玩家进度
- 页面切换需流畅，避免黑屏

### 利益相关者
- 玩家：需要清晰的导航和进度展示
- 开发者：需要可维护的代码结构
- 运营：需要基础数据埋点

## Goals / Non-Goals

### Goals
- 实现主菜单、关卡选择、设置三个核心页面
- 建立页面导航和状态管理系统
- 实现玩家进度持久化存储
- 保持吉卜力风格的视觉一致性

### Non-Goals
- 不实现收藏系统（P2 功能）
- 不实现排行榜（需要后端）
- 不实现每日任务
- 不实现皮肤系统

## Decisions

### 1. 场景管理方式

**决定**: 使用 Cocos Creator 原生场景切换 + 预加载

**实现**:
```typescript
// assets/scripts/core/SceneManager.ts
class SceneManager {
  private static _instance: SceneManager;

  async loadScene(sceneName: string, onProgress?: (p: number) => void): Promise<void> {
    // 预加载 → 切换 → 回调
  }

  preloadScene(sceneName: string): void {
    director.preloadScene(sceneName);
  }
}
```

**原因**:
- Cocos 原生 API 性能最优
- 预加载避免切换卡顿
- 简单直接，无额外依赖

### 2. 玩家进度存储

**决定**: 使用平台适配器的统一存储接口

**数据结构**:
```typescript
// assets/scripts/core/PlayerProgress.ts
interface PlayerProgressData {
  /** 当前解锁的最高关卡 */
  currentLevel: number;

  /** 每关的最佳成绩（星数 0-3） */
  levelStars: Record<number, number>;

  /** 总星数 */
  totalStars: number;

  /** 设置项 */
  settings: {
    bgmVolume: number;      // 0-1
    sfxVolume: number;      // 0-1
    vibration: boolean;
  };

  /** 上次游戏时间戳 */
  lastPlayTime: number;
}
```

**原因**:
- 复用已有的平台存储适配器
- JSON 格式便于序列化
- 支持增量更新

### 3. 关卡选择布局

**决定**: 垂直滚动列表，每行 5 个关卡

**布局**:
```
┌─────────────────────────────────┐
│         关卡选择                 │  ← 标题栏
├─────────────────────────────────┤
│  ☆☆☆  ☆☆☆  ☆☆☆  ☆☆☆  ☆☆☆   │  ← 星级指示
│   1     2     3     4     5     │  ← 关卡按钮
├─────────────────────────────────┤
│   6     7     8     9    10     │
├─────────────────────────────────┤
│  ...（可滚动）                   │
├─────────────────────────────────┤
│        [返回主菜单]              │  ← 底部按钮
└─────────────────────────────────┘
```

**原因**:
- 50 关在一屏无法全部展示
- 垂直滚动符合移动端习惯
- 每行 5 个保持视觉平衡

### 4. 主菜单布局

**决定**: 简洁的单屏设计，突出核心操作

**布局**:
```
┌─────────────────────────────────┐
│                                 │
│      🌿 灯笼叶子消消乐 🌿         │  ← 标题
│                                 │
│         [吉卜力风格插图]          │  ← 品牌图
│          猫狗角色展示             │
│                                 │
├─────────────────────────────────┤
│       当前关卡: 第 27 关          │  ← 进度信息
│       总星数: ⭐ 68/150           │
├─────────────────────────────────┤
│                                 │
│        [ 🎮 开始游戏 ]           │  ← 主按钮
│                                 │
│        [ ⚙️ 设置 ]              │  ← 次要按钮
│                                 │
├─────────────────────────────────┤
│    ⚡ 5/5 已满                   │  ← 体力显示
└─────────────────────────────────┘
```

### 5. 设置页面设计

**决定**: 简洁的列表式设置项

**布局**:
```
┌─────────────────────────────────┐
│    ←      设置                  │  ← 标题栏 + 返回
├─────────────────────────────────┤
│  🔊 背景音乐                     │
│  ━━━━━━━━━━●━━━━  80%           │  ← 滑块
├─────────────────────────────────┤
│  🔔 音效                        │
│  ━━━━━━━━━━━━━━●  100%          │  ← 滑块
├─────────────────────────────────┤
│  📳 震动反馈                     │
│               [ ON ]            │  ← 开关
├─────────────────────────────────┤
│  🌐 语言                        │
│               简体中文 >         │  ← 选择器（预留）
├─────────────────────────────────┤
│                                 │
│       [ 重置游戏进度 ]           │  ← 危险操作
│                                 │
└─────────────────────────────────┘
```

### 6. 页面过渡动画

**决定**: 淡入淡出 + 轻量缩放

**实现**:
```typescript
// 页面退出
tween(node)
  .to(0.2, { opacity: 0, scale: new Vec3(0.95, 0.95, 1) })
  .call(() => director.loadScene(nextScene))
  .start();

// 页面进入
node.opacity = 0;
node.scale = new Vec3(1.05, 1.05, 1);
tween(node)
  .to(0.2, { opacity: 255, scale: new Vec3(1, 1, 1) })
  .start();
```

**原因**:
- 轻量动画不影响性能
- 避免硬切换带来的割裂感
- 符合吉卜力风格的柔和气质

## Risks / Trade-offs

### 风险 1: 场景切换性能

**风险**: 场景资源多时切换卡顿
**缓解**:
- 预加载下一个可能的场景
- 使用 Loading 遮罩过渡
- 资源按需加载

### 风险 2: 存储数据丢失

**风险**: 本地存储可能被清理
**缓解**:
- 关键时刻主动保存
- 显示保存成功提示
- 后续可加云存档（P2）

### 风险 3: 关卡数据量

**风险**: 50 关全部渲染影响性能
**缓解**:
- 使用虚拟列表/对象池
- 只渲染可见区域
- 懒加载星级数据

## Migration Plan

### 阶段 1: 基础设施
1. 创建 SceneManager 场景管理器
2. 创建 PlayerProgress 进度管理
3. 创建 SettingsManager 设置管理

### 阶段 2: 主菜单
1. 设计并实现 MainMenuView 组件
2. 集成体力显示
3. 实现按钮交互

### 阶段 3: 关卡选择
1. 实现 LevelSelectView 组件
2. 实现关卡按钮组件
3. 实现滚动列表
4. 集成进度数据

### 阶段 4: 设置页面
1. 实现 SettingsView 组件
2. 实现滑块和开关组件
3. 集成设置持久化

### 阶段 5: 集成测试
1. 页面导航测试
2. 数据持久化测试
3. E2E 测试覆盖

### 回滚计划
- 删除新增的组件文件
- 恢复 scene 文件
- 无数据库变更，回滚成本低

## Open Questions

1. **是否需要关卡难度预览？**
   - 建议：暂不实现，保持简洁

2. **关卡解锁是否需要星数门槛？**
   - 建议：仅需通关即解锁下一关

3. **设置重置是否需要二次确认？**
   - 建议：是，使用模态确认框
