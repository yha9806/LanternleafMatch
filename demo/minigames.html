<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ç¯ç¬¼å¶å­æ¶ˆæ¶ˆä¹ - è¿·ä½ æ¸¸æˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #2d5a27 0%, #1a3518 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #fff;
      overflow-x: hidden;
    }
    .container {
      width: 100%;
      max-width: 540px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .back-btn {
      background: rgba(0,0,0,0.3);
      border: none;
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }
    .back-btn:hover { background: rgba(0,0,0,0.5); }
    h1 {
      font-size: 24px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .stats {
      background: rgba(0,0,0,0.3);
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 12px;
    }

    /* Game Selector */
    .game-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .game-tab {
      flex: 1;
      padding: 15px 10px;
      background: rgba(255,255,255,0.1);
      border: 2px solid transparent;
      border-radius: 15px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }
    .game-tab:hover { background: rgba(255,255,255,0.2); }
    .game-tab.active {
      background: rgba(255,255,255,0.25);
      border-color: #FFD700;
    }
    .game-tab .icon { font-size: 32px; margin-bottom: 5px; }
    .game-tab .name { font-size: 12px; }

    /* Game Area */
    .game-area {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .game-title { font-size: 18px; font-weight: bold; }
    .game-timer {
      font-size: 20px;
      font-weight: bold;
      color: #FFD700;
    }
    .game-timer.warning { color: #ff6b6b; animation: blink 0.5s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }

    .game-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* ============================================ */
    /* Collection Sort Game (æ”¶é›†æ•´ç†) */
    /* ============================================ */
    .sort-description {
      text-align: center;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
    }
    .sort-description .characters {
      font-size: 32px;
      margin-bottom: 5px;
    }
    .sort-description .text {
      font-size: 14px;
      opacity: 0.9;
    }
    .barrels-container {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
    }
    .barrel {
      width: 70px;
      min-height: 180px;
      display: flex;
      flex-direction: column-reverse;
      align-items: center;
      padding: 8px 5px;
      background: linear-gradient(180deg, #8B4513 0%, #654321 50%, #5D3A1A 100%);
      border: 3px solid #5D3A1A;
      border-radius: 10px 10px 15px 15px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      box-shadow: inset 0 -10px 20px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.3);
    }
    .barrel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 15px;
      background: linear-gradient(180deg, #A0522D 0%, #8B4513 100%);
      border-radius: 8px 8px 0 0;
    }
    .barrel::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 10px;
      background: #4A3520;
      border-radius: 0 0 10px 10px;
    }
    .barrel:hover:not(.empty) {
      transform: translateY(-5px);
      box-shadow: inset 0 -10px 20px rgba(0,0,0,0.3), 0 10px 25px rgba(0,0,0,0.4);
    }
    .barrel.selected {
      border-color: #FFD700;
      box-shadow: inset 0 -10px 20px rgba(0,0,0,0.3), 0 0 20px rgba(255,215,0,0.5);
    }
    .barrel.empty {
      background: linear-gradient(180deg, #6B4513 0%, #4A3520 50%, #3D2A1A 100%);
      opacity: 0.7;
    }
    .barrel.complete {
      border-color: #4CAF50;
      box-shadow: inset 0 -10px 20px rgba(0,0,0,0.3), 0 0 20px rgba(76,175,80,0.5);
    }
    .barrel .item {
      width: 50px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-top: 4px;
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      animation: itemDrop 0.3s ease-out;
    }
    @keyframes itemDrop {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .barrel .item.moving {
      animation: itemMove 0.3s ease-out;
    }
    @keyframes itemMove {
      0% { transform: scale(1); }
      50% { transform: scale(1.2) translateY(-10px); }
      100% { transform: scale(1); }
    }
    .sort-info {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      font-size: 14px;
    }
    .sort-info span {
      background: rgba(0,0,0,0.2);
      padding: 8px 15px;
      border-radius: 20px;
    }
    .sort-rule {
      margin-top: 12px;
      padding: 8px 15px;
      background: rgba(255,215,0,0.15);
      border: 1px solid rgba(255,215,0,0.3);
      border-radius: 10px;
      font-size: 12px;
      color: #FFD700;
      text-align: center;
    }
    .sort-rule strong {
      color: #fff;
    }
    .sort-hints {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .hint-btn {
      padding: 10px 15px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .hint-btn:hover { background: rgba(255,255,255,0.25); }
    .hint-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .hint-btn .icon { margin-right: 5px; }

    /* ============================================ */
    /* Forest Rescue Game (æ£®æ—æ•‘æ´) */
    /* ============================================ */
    .rescue-scene {
      text-align: center;
      margin-bottom: 20px;
      position: relative;
    }
    .rescue-visual {
      position: relative;
      width: 280px;
      height: 200px;
      margin: 0 auto 15px;
      background: linear-gradient(180deg, #87CEEB 0%, #98D8AA 50%, #654321 100%);
      border-radius: 15px;
      overflow: hidden;
    }
    .rescue-character {
      position: absolute;
      font-size: 50px;
      transition: all 0.5s ease;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
    }
    .rescue-character.scared {
      animation: scared 0.5s ease-in-out infinite;
    }
    .rescue-character.happy {
      animation: happy 0.3s ease-in-out 3;
    }
    .rescue-character.sad {
      animation: sad 0.5s ease-in-out;
    }
    @keyframes scared {
      0%, 100% { transform: translateX(-2px) rotate(-2deg); }
      50% { transform: translateX(2px) rotate(2deg); }
    }
    @keyframes happy {
      0%, 100% { transform: scale(1) rotate(0); }
      50% { transform: scale(1.2) rotate(10deg); }
    }
    @keyframes sad {
      0% { transform: translateY(0); }
      50% { transform: translateY(10px); }
      100% { transform: translateY(0); }
    }
    .rescue-obstacle {
      position: absolute;
      font-size: 35px;
      cursor: pointer;
      transition: all 0.3s;
      filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3));
    }
    .rescue-obstacle:hover {
      transform: scale(1.1);
      filter: brightness(1.2) drop-shadow(0 0 10px rgba(255,255,255,0.5));
    }
    .rescue-obstacle.removed {
      animation: obstacleRemove 0.5s ease-out forwards;
    }
    @keyframes obstacleRemove {
      to { opacity: 0; transform: scale(0) rotate(180deg); }
    }
    .rescue-element {
      position: absolute;
      font-size: 25px;
      pointer-events: none;
    }
    .rescue-element.falling {
      animation: elementFall 0.8s ease-in forwards;
    }
    @keyframes elementFall {
      to { transform: translateY(100px); opacity: 0; }
    }
    .rescue-lure {
      position: absolute;
      font-size: 30px;
      cursor: pointer;
      animation: lureFloat 1s ease-in-out infinite;
    }
    @keyframes lureFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    .rescue-description {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }
    .countdown-ring {
      position: relative;
      width: 80px;
      height: 80px;
      margin: 0 auto 15px;
    }
    .countdown-ring svg {
      transform: rotate(-90deg);
      width: 80px;
      height: 80px;
    }
    .countdown-ring circle {
      fill: none;
      stroke-width: 6;
    }
    .countdown-ring .bg { stroke: rgba(255,255,255,0.2); }
    .countdown-ring .progress {
      stroke: #FFD700;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s linear;
    }
    .countdown-ring .progress.warning { stroke: #ff6b6b; }
    .countdown-ring .time {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 22px;
      font-weight: bold;
    }

    /* ============================================ */
    /* Forest Explore Game (æ£®æ—æ¢ç´¢) */
    /* ============================================ */
    .explore-description {
      text-align: center;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
    }
    .explore-description .characters {
      font-size: 32px;
      margin-bottom: 5px;
    }
    .explore-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 20px;
      position: relative;
    }
    .explore-cell {
      width: 55px;
      height: 55px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: linear-gradient(145deg, #228B22, #1a6b1a);
      border: 2px solid #165016;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: inset 0 -2px 4px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }
    .explore-cell::before {
      content: 'ğŸŒ¿';
      font-size: 20px;
      opacity: 0.6;
    }
    .explore-cell:hover:not(.revealed) {
      background: linear-gradient(145deg, #2a9b2a, #1f7f1f);
      transform: scale(1.05);
    }
    .explore-cell.revealed {
      background: linear-gradient(145deg, #D2B48C, #C4A47C);
      border-color: #A08060;
      cursor: default;
    }
    .explore-cell.revealed::before { content: none; }
    .explore-cell.digging {
      animation: dig-shake 0.3s ease-out;
    }
    @keyframes dig-shake {
      0%, 100% { transform: rotate(0); }
      25% { transform: rotate(-5deg) scale(0.95); }
      50% { transform: rotate(5deg) scale(0.95); }
      75% { transform: rotate(-3deg); }
    }
    .explore-cell .dirt-particle {
      position: absolute;
      width: 6px;
      height: 6px;
      background: #654321;
      border-radius: 50%;
      pointer-events: none;
      animation: dirt-spray 0.6s ease-out forwards;
    }
    @keyframes dirt-spray {
      0% { opacity: 1; transform: translate(0, 0) scale(1); }
      100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.3); }
    }
    .explore-cell.treasure {
      background: linear-gradient(145deg, #FFD700, #FFA500);
      border-color: #FF8C00;
      animation: treasure-glow 1s infinite, treasure-bounce 0.5s ease-out;
    }
    @keyframes treasure-glow {
      0%, 100% { box-shadow: 0 0 10px #FFD700; }
      50% { box-shadow: 0 0 25px #FFD700, 0 0 40px #FFA500; }
    }
    @keyframes treasure-bounce {
      0% { transform: scale(0.5) rotate(-10deg); }
      50% { transform: scale(1.3) rotate(5deg); }
      75% { transform: scale(0.9) rotate(-2deg); }
      100% { transform: scale(1) rotate(0); }
    }
    .explore-cell .hint-number {
      position: absolute;
      font-size: 16px;
      font-weight: bold;
      color: #333;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
    }
    .explore-cell.hint-cold { box-shadow: inset 0 0 15px rgba(100, 150, 255, 0.5); }
    .explore-cell.hint-warm { box-shadow: inset 0 0 15px rgba(255, 200, 100, 0.5); }
    .explore-cell.hint-hot { box-shadow: inset 0 0 15px rgba(255, 100, 50, 0.7); }
    .explore-cell.hint-fire {
      box-shadow: inset 0 0 20px rgba(255, 50, 0, 0.8);
      animation: fire-pulse 0.5s ease-in-out infinite;
    }
    @keyframes fire-pulse {
      0%, 100% { box-shadow: inset 0 0 15px rgba(255, 50, 0, 0.6); }
      50% { box-shadow: inset 0 0 25px rgba(255, 100, 0, 0.9); }
    }
    .explore-cell .reward-popup {
      position: absolute;
      font-size: 12px;
      font-weight: bold;
      color: #FFD700;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      animation: reward-float 1s ease-out forwards;
      pointer-events: none;
    }
    @keyframes reward-float {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-30px) scale(1.2); }
    }
    .explore-info {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      font-size: 14px;
    }
    .explore-info .item {
      background: rgba(0,0,0,0.2);
      padding: 8px 15px;
      border-radius: 20px;
      transition: transform 0.2s;
    }
    .explore-info .item.pulse {
      animation: info-pulse 0.3s ease-out;
    }
    @keyframes info-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    /* æ–°ç‰ˆæ‰«é›·æ¢ç´¢ V2 æ ·å¼ */
    .explore-toolbar {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    .tool-btn {
      padding: 8px 12px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 15px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .tool-btn:hover:not(:disabled) {
      background: rgba(255,255,255,0.25);
    }
    .tool-btn.active {
      background: rgba(255,150,0,0.4);
      border-color: #FFA500;
    }
    .tool-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .explore-cell.trap {
      background: linear-gradient(145deg, #8B0000, #5a0000) !important;
      border-color: #3a0000 !important;
      animation: trap-reveal 0.5s ease-out;
    }
    @keyframes trap-reveal {
      0% { transform: scale(1.5); }
      50% { transform: scale(0.8); }
      100% { transform: scale(1); }
    }
    .explore-cell.exit {
      background: linear-gradient(145deg, #4169E1, #2a4a9a) !important;
      border-color: #1a3a7a !important;
    }
    .explore-cell.start {
      background: linear-gradient(145deg, #90EE90, #70cc70) !important;
      border-color: #50aa50 !important;
    }
    .explore-cell.flagged {
      background: linear-gradient(145deg, #FFD700, #cc9900);
    }

    /* æ•°å­—é¢œè‰² */
    .explore-cell.number-1 { color: #0000FF; }
    .explore-cell.number-2 { color: #008000; }
    .explore-cell.number-3 { color: #FF0000; }
    .explore-cell.number-4 { color: #000080; }
    .explore-cell.number-5 { color: #800000; }
    .explore-cell.number-6 { color: #008080; }
    .explore-cell.number-7 { color: #000000; }
    .explore-cell.number-8 { color: #808080; }

    .explore-cell.revealed.number-1,
    .explore-cell.revealed.number-2,
    .explore-cell.revealed.number-3,
    .explore-cell.revealed.number-4,
    .explore-cell.revealed.number-5,
    .explore-cell.revealed.number-6,
    .explore-cell.revealed.number-7,
    .explore-cell.revealed.number-8 {
      font-weight: bold;
      font-size: 20px;
    }

    /* éœ‡åŠ¨åŠ¨ç”» */
    .shake {
      animation: shake-screen 0.5s ease-out;
    }
    @keyframes shake-screen {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-10px); }
      40% { transform: translateX(10px); }
      60% { transform: translateX(-5px); }
      80% { transform: translateX(5px); }
    }

    /* å®ç‰©æ”¶é›†åŠ¨ç”» */
    .treasure-collect-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: overlay-fade-in 0.3s ease-out;
    }
    @keyframes overlay-fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .treasure-box {
      position: relative;
      animation: treasure-appear 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes treasure-appear {
      0% { transform: scale(0) rotate(-30deg); opacity: 0; }
      60% { transform: scale(1.3) rotate(5deg); }
      100% { transform: scale(1) rotate(0); opacity: 1; }
    }
    .treasure-icon {
      font-size: 80px;
      text-shadow: 0 0 30px rgba(255,215,0,0.8), 0 0 60px rgba(255,165,0,0.5);
      animation: treasure-glow-big 1s ease-in-out infinite alternate;
    }
    @keyframes treasure-glow-big {
      from { filter: brightness(1) drop-shadow(0 0 20px gold); }
      to { filter: brightness(1.3) drop-shadow(0 0 40px gold); }
    }
    .treasure-sparkles {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200px;
      height: 200px;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .sparkle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: radial-gradient(circle, #FFD700 0%, transparent 70%);
      border-radius: 50%;
      animation: sparkle-burst 1s ease-out forwards;
    }
    @keyframes sparkle-burst {
      0% { opacity: 1; transform: translate(0, 0) scale(1); }
      100% { opacity: 0; transform: translate(var(--sx), var(--sy)) scale(0); }
    }
    .treasure-reward {
      position: absolute;
      top: 110%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 28px;
      font-weight: bold;
      color: #FFD700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      white-space: nowrap;
      animation: reward-bounce-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s both;
    }
    @keyframes reward-bounce-in {
      0% { transform: translateX(-50%) scale(0); opacity: 0; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }
    .treasure-coins-fly {
      position: fixed;
      font-size: 24px;
      z-index: 1001;
      animation: coin-fly 0.8s ease-in forwards;
      pointer-events: none;
    }
    @keyframes coin-fly {
      0% { opacity: 1; }
      100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0.5); }
    }

    /* èƒœåˆ©ç»“ç®—ç•Œé¢ */
    .victory-modal {
      background: linear-gradient(180deg, #2d1b4e 0%, #1a1030 100%);
      border: 3px solid #FFD700;
      border-radius: 20px;
      padding: 30px;
      min-width: 320px;
      text-align: center;
      animation: victory-slide-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes victory-slide-in {
      0% { transform: translateY(-100px) scale(0.5); opacity: 0; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    .victory-title {
      font-size: 32px;
      font-weight: bold;
      color: #FFD700;
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
      margin-bottom: 10px;
    }
    .victory-level {
      font-size: 18px;
      color: #aaa;
      margin-bottom: 20px;
    }
    .victory-stars {
      font-size: 40px;
      margin-bottom: 20px;
    }
    .victory-star {
      display: inline-block;
      opacity: 0;
      transform: scale(0) rotate(-180deg);
      animation: star-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    .victory-star:nth-child(1) { animation-delay: 0.2s; }
    .victory-star:nth-child(2) { animation-delay: 0.4s; }
    .victory-star:nth-child(3) { animation-delay: 0.6s; }
    .victory-star.empty { filter: grayscale(1) brightness(0.5); }
    @keyframes star-pop {
      to { opacity: 1; transform: scale(1) rotate(0); }
    }
    .victory-stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 25px;
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
    }
    .stat-item {
      text-align: center;
    }
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #fff;
    }
    .stat-value.counting {
      animation: count-pulse 0.1s ease-in-out;
    }
    @keyframes count-pulse {
      50% { transform: scale(1.2); color: #FFD700; }
    }
    .stat-label {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
    .victory-rewards {
      margin-bottom: 20px;
    }
    .reward-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      font-size: 20px;
      opacity: 0;
      animation: reward-slide-in 0.4s ease-out forwards;
    }
    .reward-row:nth-child(1) { animation-delay: 0.8s; }
    .reward-row:nth-child(2) { animation-delay: 1.0s; }
    .reward-row:nth-child(3) { animation-delay: 1.2s; }
    @keyframes reward-slide-in {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .victory-btn {
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(180deg, #4CAF50 0%, #2E7D32 100%);
      border: none;
      border-radius: 30px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(76,175,80,0.4);
      transition: all 0.3s;
      opacity: 0;
      animation: btn-appear 0.5s ease-out 1.4s forwards;
    }
    @keyframes btn-appear {
      to { opacity: 1; }
    }
    .victory-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(76,175,80,0.6);
    }

    /* å¤±è´¥ç•Œé¢ */
    .defeat-modal {
      background: linear-gradient(180deg, #3d1f1f 0%, #1a0a0a 100%);
      border: 3px solid #8B0000;
    }
    .defeat-modal .victory-title {
      color: #ff6666;
      text-shadow: 0 0 10px rgba(255,100,100,0.5);
    }
    .defeat-btn {
      background: linear-gradient(180deg, #FF5722 0%, #D84315 100%);
      box-shadow: 0 4px 15px rgba(255,87,34,0.4);
    }
    .defeat-btn:hover {
      box-shadow: 0 6px 20px rgba(255,87,34,0.6);
    }

    /* å•†åº—æ ·å¼ */
    .shop-items {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }
    .shop-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .shop-item:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.02);
    }
    .shop-item .item-icon {
      font-size: 24px;
    }
    .shop-item .item-name {
      flex: 1;
      margin-left: 10px;
    }
    .shop-item .item-price {
      font-weight: bold;
      color: #FFD700;
    }
    .shop-balance {
      text-align: center;
      margin: 10px 0;
      font-size: 16px;
      font-weight: bold;
    }

    .game-stats {
      display: flex;
      gap: 10px;
      font-size: 14px;
    }
    .game-stats .lives {
      letter-spacing: 2px;
    }

    .explore-abilities {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .ability-btn {
      padding: 10px 15px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .ability-btn:hover { background: rgba(255,255,255,0.25); }
    .ability-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .ability-btn .icon { margin-right: 5px; }

    /* Result Modal */
    .result-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .result-modal.show { display: flex; }
    .result-content {
      background: linear-gradient(145deg, #3d7a37, #2d5a27);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      min-width: 300px;
      animation: popIn 0.3s ease-out;
    }
    /* æ£®æ—æ¢ç´¢ä½¿ç”¨æ–°æ ·å¼æ—¶ï¼Œå®¹å™¨é€æ˜ */
    .result-content:has(.victory-modal) {
      background: transparent;
      padding: 0;
    }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .result-icon { font-size: 64px; margin-bottom: 15px; }
    .result-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
    .result-rewards {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .result-reward {
      background: rgba(0,0,0,0.2);
      padding: 10px 20px;
      border-radius: 10px;
    }
    .result-reward .value { font-size: 20px; font-weight: bold; }
    .result-reward .label { font-size: 12px; opacity: 0.8; }
    .result-btn {
      padding: 15px 40px;
      background: linear-gradient(145deg, #FFD700, #FFA500);
      border: none;
      border-radius: 25px;
      color: #333;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    .result-btn:hover { transform: scale(1.05); }

    /* Start Button */
    .start-btn {
      padding: 20px 60px;
      background: linear-gradient(145deg, #FFD700, #FFA500);
      border: none;
      border-radius: 30px;
      color: #333;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255,215,0,0.4);
      transition: all 0.2s;
    }
    .start-btn:hover { transform: scale(1.05); }
    .start-btn:disabled {
      background: #666;
      cursor: not-allowed;
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="back-btn" onclick="location.href='menu.html'">â† è¿”å›</button>
      <h1>ğŸŒ² æ£®æ—è¿·ä½ æ¸¸æˆ</h1>
      <div class="stats" id="stats">å·²ç©: 0</div>
    </div>

    <div class="game-selector">
      <div class="game-tab active" data-game="sort" onclick="selectGame('sort')">
        <div class="icon">ğŸª£</div>
        <div class="name">æ”¶é›†æ•´ç†</div>
      </div>
      <div class="game-tab" data-game="rescue" onclick="selectGame('rescue')">
        <div class="icon">ğŸ±</div>
        <div class="name">æ£®æ—æ•‘æ´</div>
      </div>
      <div class="game-tab" data-game="explore" onclick="selectGame('explore')">
        <div class="icon">ğŸ—ºï¸</div>
        <div class="name">æ£®æ—æ¢ç´¢</div>
      </div>
    </div>

    <div class="game-area" id="gameArea">
      <!-- Game content rendered here -->
    </div>
  </div>

  <div class="result-modal" id="resultModal">
    <div class="result-content">
      <div class="result-icon" id="resultIcon">ğŸ‰</div>
      <div class="result-title" id="resultTitle">æˆåŠŸ!</div>
      <div class="result-rewards" id="resultRewards"></div>
      <button class="result-btn" onclick="closeResult()">ç»§ç»­</button>
    </div>
  </div>

<script>
// ============================================
// æ¸¸æˆå…ƒç´ å®šä¹‰ - ä¸ä¸»æ¸¸æˆä¸€è‡´
// ============================================
const GAME_ELEMENTS = [
  { id: 'leaf', icon: 'ğŸƒ', name: 'å¶å­' },
  { id: 'acorn', icon: 'ğŸŒ°', name: 'æ©¡æœ' },
  { id: 'star', icon: 'â­', name: 'æ˜Ÿå±‘' },
  { id: 'fish', icon: 'ğŸŸ', name: 'é±¼å¹²' },
  { id: 'bone', icon: 'ğŸ¦´', name: 'éª¨å¤´' },
];

const CHARACTERS = {
  cat: { icon: 'ğŸ±', name: 'Mochi', sensesItem: 'fish' },
  dog: { icon: 'ğŸ¶', name: 'Taro', sensesItem: 'bone' },
};

// ============================================
// Game State
// ============================================
let currentGame = 'sort';
let gameState = 'idle'; // idle, playing, complete
let totalPlayed = 0;

// Collection Sort Game State
let sortBarrels = [];
let sortMoves = 0;
let sortMaxMoves = 15;
let sortLayers = 4; // å½“å‰éš¾åº¦çš„å±‚æ•°
let sortTargetBarrels = 3; // éœ€è¦å®Œæˆçš„æ¡¶æ•° (= types)
let sortCurrentElements = []; // å½“å‰æ¸¸æˆä½¿ç”¨çš„å…ƒç´ ç±»å‹
let sortSelectedBarrel = -1;
let sortHintsUsed = {}; // åŠ¨æ€ï¼š{ elementId: boolean }

// Forest Rescue Game State
let rescueScenario = null;
let rescueTimer = null;
let rescueTimeRemaining = 15;
let rescueObstacles = [];
let rescueElementsUsed = [];

// Forest Explore Game State (Minesweeper V2)
let exploreGrid = [];
let exploreLevel = 1;
let exploreLives = 3;
let exploreMaxLives = 3;
let exploreCoins = 0;
let exploreGems = 0;
let exploreItems = { maps: 1, picks: 1 };
let exploreGameStatus = 'idle'; // 'playing' | 'won' | 'lost' | 'shopping'
let exploreFlagMode = false;
let exploreStartPos = null;
let exploreExitPos = null;
// ç»Ÿè®¡æ•°æ®
let exploreStats = {
  cellsRevealed: 0,
  treasuresCollected: 0,
  trapsHit: 0,
  levelStartCoins: 0,
  levelStartGems: 0
};

// ============================================
// Collection Sort Game (æ”¶é›†æ•´ç†)
// ============================================
const SORT_DIFFICULTIES = {
  // æ ‡å‡† Ball Sort éœ€è¦ types + 2 ä¸ªæ¡¶æ‰èƒ½ä¿è¯å¯è§£
  easy: { barrels: 5, types: 3, layers: 3, moves: 15 },   // 3ç§+2ç©ºæ¡¶
  medium: { barrels: 6, types: 4, layers: 4, moves: 20 }, // 4ç§+2ç©ºæ¡¶
  hard: { barrels: 7, types: 5, layers: 4, moves: 28 },   // 5ç§+2ç©ºæ¡¶
};

function initSortGame(difficulty = 'easy') {
  const config = SORT_DIFFICULTIES[difficulty];
  const elements = GAME_ELEMENTS.slice(0, config.types);

  // åˆ›å»ºæœ¨æ¡¶å†…å®¹
  sortBarrels = [];
  const allItems = [];

  // æ¯ç§å…ƒç´ åˆ›å»º layers ä¸ª
  for (const elem of elements) {
    for (let i = 0; i < config.layers; i++) {
      allItems.push({ ...elem });
    }
  }

  // æ‰“ä¹±
  for (let i = allItems.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [allItems[i], allItems[j]] = [allItems[j], allItems[i]];
  }

  // åˆ†é…åˆ°æœ¨æ¡¶ (types ä¸ªæœ‰ç‰©å“ï¼Œå‰©ä½™ä¸ºç©ºæ¡¶)
  const itemsPerBarrel = config.layers;
  for (let i = 0; i < config.types; i++) {
    const barrel = allItems.slice(i * itemsPerBarrel, (i + 1) * itemsPerBarrel);
    sortBarrels.push(barrel);
  }
  // æ·»åŠ ç©ºæ¡¶ (barrels - types ä¸ªï¼Œé€šå¸¸æ˜¯ 2 ä¸ª)
  for (let i = 0; i < config.barrels - config.types; i++) {
    sortBarrels.push([]);
  }

  sortMoves = 0;
  sortMaxMoves = config.moves;
  sortLayers = config.layers; // å½“å‰éš¾åº¦çš„å±‚æ•°
  sortTargetBarrels = config.types; // éœ€è¦å®Œæˆçš„æ¡¶æ•°
  sortCurrentElements = elements; // ä¿å­˜å½“å‰ä½¿ç”¨çš„å…ƒç´ 
  sortSelectedBarrel = -1;
  // åŠ¨æ€åˆå§‹åŒ–æç¤ºçŠ¶æ€ï¼ˆæ¯ç§å…ƒç´ ä¸€ä¸ªæç¤ºæœºä¼šï¼‰
  sortHintsUsed = {};
  elements.forEach(e => sortHintsUsed[e.id] = false);
  gameState = 'playing';
}

function renderSortGame() {
  const area = document.getElementById('gameArea');

  area.innerHTML = `
    <div class="game-header">
      <div class="game-title">ğŸª£ æ”¶é›†æ•´ç†</div>
      <div class="game-timer">æ­¥æ•°: ${sortMoves}/${sortMaxMoves}</div>
    </div>
    <div class="game-content">
      <div class="sort-description">
        <div class="characters">${CHARACTERS.cat.icon} ${CHARACTERS.dog.icon}</div>
        <div class="text">å¸® Mochi å’Œ Taro æ•´ç†æ”¶é›†çš„å®è´ï¼æ¯æ¡¶åªæ”¾åŒä¸€ç§ç‰©å“</div>
      </div>
      <div class="barrels-container">
        ${sortBarrels.map((barrel, i) => {
          const isComplete = barrel.length > 0 && barrel.every(item => item.id === barrel[0].id) && barrel.length === sortLayers;
          const isEmpty = barrel.length === 0;
          const isSelected = sortSelectedBarrel === i;
          return `
            <div class="barrel ${isEmpty ? 'empty' : ''} ${isComplete ? 'complete' : ''} ${isSelected ? 'selected' : ''}"
                 data-index="${i}" onclick="clickBarrel(${i})">
              ${barrel.map((item, j) => `
                <div class="item" style="animation-delay: ${j * 0.05}s">${item.icon}</div>
              `).join('')}
            </div>
          `;
        }).join('')}
      </div>
      <div class="sort-info">
        <span>å®Œæˆ: ${countCompletedBarrels()}/${sortTargetBarrels}</span>
        <span>æ­¥æ•°: ${sortMoves}/${sortMaxMoves}</span>
      </div>
      <div class="sort-rule">
        ğŸ’¡ åªèƒ½æ”¾åˆ°<strong>ç©ºæ¡¶</strong>æˆ–<strong>ç›¸åŒå…ƒç´ </strong>çš„æ¡¶é¡¶
      </div>
      <div class="sort-hints">
        ${sortCurrentElements.map(elem => `
          <button class="hint-btn" onclick="useSortHintFor('${elem.id}')" ${sortHintsUsed[elem.id] ? 'disabled' : ''}>
            é«˜äº®${elem.icon}
          </button>
        `).join('')}
      </div>
    </div>
  `;
}

function clickBarrel(index) {
  if (gameState !== 'playing') return;

  if (sortSelectedBarrel === -1) {
    // é€‰æ‹©æœ¨æ¡¶ï¼ˆå¿…é¡»æœ‰å…ƒç´ ï¼‰
    if (sortBarrels[index].length > 0) {
      sortSelectedBarrel = index;
      renderSortGame();
    }
  } else {
    if (sortSelectedBarrel === index) {
      // å–æ¶ˆé€‰æ‹©
      sortSelectedBarrel = -1;
      renderSortGame();
      return;
    }

    // å°è¯•ç§»åŠ¨
    const fromBarrel = sortBarrels[sortSelectedBarrel];
    const toBarrel = sortBarrels[index];
    const movingItem = fromBarrel[fromBarrel.length - 1];

    // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç§»åŠ¨
    const canMove = toBarrel.length === 0 ||
                    (toBarrel.length < sortLayers && toBarrel[toBarrel.length - 1].id === movingItem.id);

    if (canMove) {
      // æ‰§è¡Œç§»åŠ¨
      fromBarrel.pop();
      toBarrel.push(movingItem);
      sortMoves++;

      // æ£€æŸ¥èƒœåˆ©
      if (checkSortWin()) {
        gameState = 'complete';
        const perfectBonus = sortMoves <= sortMaxMoves * 0.6;
        showResult(true, {
          coins: perfectBonus ? 150 : 100,
          message: perfectBonus ? 'å®Œç¾é€šå…³!' : 'æ•´ç†å®Œæˆ!'
        });
      } else if (sortMoves >= sortMaxMoves) {
        gameState = 'complete';
        showResult(false, { coins: 30 });
      }
    }

    sortSelectedBarrel = -1;
    renderSortGame();
  }
}

function countCompletedBarrels() {
  return sortBarrels.filter(barrel =>
    barrel.length === sortLayers && barrel.every(item => item.id === barrel[0].id)
  ).length;
}

function checkSortWin() {
  // é™¤äº†ç©ºæ¡¶å¤–ï¼Œæ‰€æœ‰æ¡¶éƒ½å®Œæˆ
  const nonEmptyBarrels = sortBarrels.filter(b => b.length > 0);
  return nonEmptyBarrels.every(barrel =>
    barrel.length === sortLayers && barrel.every(item => item.id === barrel[0].id)
  );
}

// æ–°ç‰ˆï¼šé«˜äº®æŒ‡å®šå…ƒç´ ç±»å‹
function useSortHintFor(elementId) {
  if (sortHintsUsed[elementId]) return;
  sortHintsUsed[elementId] = true;

  // å…ˆé‡æ–°æ¸²æŸ“æ›´æ–°æŒ‰é’®çŠ¶æ€
  renderSortGame();

  // ç„¶ååº”ç”¨é«˜äº®æ•ˆæœï¼ˆæ¸²æŸ“åå†åº”ç”¨ï¼Œé¿å…è¢«è¦†ç›–ï¼‰
  setTimeout(() => {
    const barrelElements = document.querySelectorAll('.barrel');
    sortBarrels.forEach((barrel, i) => {
      if (barrel.some(item => item.id === elementId)) {
        barrelElements[i].style.boxShadow = 'inset 0 -10px 20px rgba(0,0,0,0.3), 0 0 20px rgba(255,215,0,0.8)';
        barrelElements[i].style.transition = 'box-shadow 0.3s';
        setTimeout(() => {
          barrelElements[i].style.boxShadow = '';
        }, 2000);
      }
    });
  }, 50);
}

// ============================================
// Forest Rescue Game (æ£®æ—æ•‘æ´)
// ============================================
const RESCUE_SCENARIOS = [
  {
    id: 'cat_tree',
    character: 'cat',
    description: 'Mochi è¢«å›°åœ¨æ ‘ä¸Šï¼æŒ‰æ­£ç¡®é¡ºåºç§»é™¤éšœç¢ç‰©',
    obstacles: [
      { id: 'moss1', icon: 'ğŸŒ¿', type: 'moss', position: { x: 40, y: 80 }, order: 1 },
      { id: 'branch', icon: 'ğŸªµ', type: 'branch', position: { x: 100, y: 50 }, order: 2 },
      { id: 'leaves', icon: 'ğŸƒ', type: 'cushion', position: { x: 70, y: 140 }, order: 3 },
    ],
    characterPos: { x: 100, y: 30 },
    safePos: { x: 100, y: 150 },
    lure: { icon: 'ğŸŸ', position: { x: 140, y: 160 } },
    rewards: { coins: 120, booster: 'rocket' },
  },
  {
    id: 'dog_river',
    character: 'dog',
    description: 'Taro éœ€è¦è¿‡æ²³ï¼æŒ‰æ­£ç¡®é¡ºåºæ­å»ºè·¯å¾„',
    obstacles: [
      { id: 'rock1', icon: 'ğŸª¨', type: 'rock', position: { x: 60, y: 100 }, order: 2 },
      { id: 'moss2', icon: 'ğŸŒ¿', type: 'moss', position: { x: 120, y: 100 }, order: 1 },
      { id: 'acorns', icon: 'ğŸŒ°', type: 'bridge', position: { x: 90, y: 120 }, order: 3 },
    ],
    characterPos: { x: 30, y: 90 },
    safePos: { x: 200, y: 90 },
    lure: { icon: 'ğŸ¦´', position: { x: 220, y: 90 } },
    rewards: { coins: 120, booster: 'bomb' },
  },
  {
    id: 'cat_rain',
    character: 'cat',
    description: 'ä¸‹é›¨äº†ï¼å¸® Mochi æ‰¾åˆ°å¶å­ä¼',
    obstacles: [
      { id: 'star1', icon: 'â­', type: 'light', position: { x: 80, y: 60 }, order: 1 },
      { id: 'leaves2', icon: 'ğŸƒğŸƒ', type: 'umbrella', position: { x: 130, y: 40 }, order: 3 },
      { id: 'moss3', icon: 'ğŸŒ¿', type: 'moss', position: { x: 160, y: 90 }, order: 2 },
    ],
    characterPos: { x: 50, y: 100 },
    safePos: { x: 130, y: 60 },
    lure: { icon: 'ğŸŸ', position: { x: 50, y: 140 } },
    rewards: { coins: 100, gems: 1 },
  },
];

function initRescueGame() {
  rescueScenario = RESCUE_SCENARIOS[Math.floor(Math.random() * RESCUE_SCENARIOS.length)];
  rescueTimeRemaining = 15;
  rescueObstacles = rescueScenario.obstacles.map(o => ({ ...o, removed: false }));
  rescueElementsUsed = [];
  gameState = 'playing';

  rescueTimer = setInterval(() => {
    rescueTimeRemaining--;
    updateRescueTimer();
    if (rescueTimeRemaining <= 0) {
      clearInterval(rescueTimer);
      endRescueGame(false);
    }
  }, 1000);
}

function renderRescueGame() {
  const area = document.getElementById('gameArea');
  const s = rescueScenario;
  const char = CHARACTERS[s.character];
  const circumference = 2 * Math.PI * 35;
  const dashoffset = circumference * (1 - rescueTimeRemaining / 15);

  area.innerHTML = `
    <div class="game-header">
      <div class="game-title">ğŸŒ² æ£®æ—æ•‘æ´</div>
      <div class="countdown-ring">
        <svg>
          <circle class="bg" cx="40" cy="40" r="35"></circle>
          <circle class="progress ${rescueTimeRemaining <= 5 ? 'warning' : ''}"
                  cx="40" cy="40" r="35"
                  style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${dashoffset}">
          </circle>
        </svg>
        <div class="time">${rescueTimeRemaining}</div>
      </div>
    </div>
    <div class="game-content">
      <div class="rescue-description">${s.description}</div>
      <div class="rescue-visual">
        <div class="rescue-character ${gameState === 'playing' ? 'scared' : ''}"
             id="rescueChar"
             style="left: ${s.characterPos.x}px; top: ${s.characterPos.y}px;">
          ${char.icon}
        </div>
        ${rescueObstacles.map(o => `
          <div class="rescue-obstacle ${o.removed ? 'removed' : ''}"
               data-id="${o.id}"
               style="left: ${o.position.x}px; top: ${o.position.y}px;"
               onclick="clickObstacle('${o.id}')">
            ${o.icon}
          </div>
        `).join('')}
        <div class="rescue-lure" style="left: ${s.lure.position.x}px; top: ${s.lure.position.y}px;">
          ${s.lure.icon}
        </div>
      </div>
      <div class="sort-info">
        <span>é¡ºåºæç¤º: ${getOrderHint()}</span>
      </div>
    </div>
  `;
}

function getOrderHint() {
  const remaining = rescueObstacles.filter(o => !o.removed).sort((a, b) => a.order - b.order);
  if (remaining.length === 0) return 'å®Œæˆ!';
  return remaining.map(o => o.icon).join(' â†’ ');
}

function clickObstacle(id) {
  if (gameState !== 'playing') return;

  const obstacle = rescueObstacles.find(o => o.id === id);
  if (!obstacle || obstacle.removed) return;

  // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰åº”è¯¥ç§»é™¤çš„
  const remaining = rescueObstacles.filter(o => !o.removed).sort((a, b) => a.order - b.order);
  const nextObstacle = remaining[0];

  if (obstacle.id === nextObstacle.id) {
    // æ­£ç¡®ï¼
    obstacle.removed = true;
    rescueElementsUsed.push(obstacle);

    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
    if (rescueObstacles.every(o => o.removed)) {
      clearInterval(rescueTimer);
      // ç§»åŠ¨è§’è‰²åˆ°å®‰å…¨ä½ç½®
      setTimeout(() => {
        const charEl = document.getElementById('rescueChar');
        if (charEl) {
          charEl.classList.remove('scared');
          charEl.classList.add('happy');
          charEl.style.left = rescueScenario.safePos.x + 'px';
          charEl.style.top = rescueScenario.safePos.y + 'px';
        }
      }, 300);
      setTimeout(() => endRescueGame(true), 1000);
    }
  } else {
    // é”™è¯¯é¡ºåº - æ‰£æ—¶é—´
    rescueTimeRemaining = Math.max(0, rescueTimeRemaining - 3);
    const el = document.querySelector(`.rescue-obstacle[data-id="${id}"]`);
    if (el) {
      el.style.animation = 'wrong-shake 0.3s';
      setTimeout(() => el.style.animation = '', 300);
    }
  }

  renderRescueGame();
}

function updateRescueTimer() {
  const timeEl = document.querySelector('.countdown-ring .time');
  const progressEl = document.querySelector('.countdown-ring .progress');
  if (timeEl) timeEl.textContent = rescueTimeRemaining;
  if (progressEl) {
    const circumference = 2 * Math.PI * 35;
    progressEl.style.strokeDashoffset = circumference * (1 - rescueTimeRemaining / 15);
    if (rescueTimeRemaining <= 5) progressEl.classList.add('warning');
  }
}

function endRescueGame(success) {
  gameState = 'complete';
  const rewards = success ? rescueScenario.rewards : { coins: 25 };
  showResult(success, rewards);
}

// ============================================
// Forest Explore Game V2 (æ£®æ—æ¢ç´¢ - æ‰«é›·ç‰ˆ)
// ============================================

// å…³å¡é…ç½®
const EXPLORE_LEVELS = {
  getSize: (level) => Math.min(5 + Math.floor((level - 1) / 5), 9),
  getTraps: (level) => Math.min(3 + Math.floor(level * 0.8), 20),
  getTreasures: (level) => Math.min(2 + Math.floor(level / 3), 6),
};

// å†…å®¹ç±»å‹
const EXPLORE_CELL_TYPES = {
  empty: { icon: '', isPassable: true },
  trap: { icon: 'ğŸ’€', isPassable: false },
  treasure: { icon: 'ğŸ', isPassable: true, reward: { coins: 50 } },
  gem: { icon: 'ğŸ’', isPassable: true, reward: { gems: 1 } },
  acorn: { icon: 'ğŸŒ°', isPassable: true, reward: { coins: 20 } },
  fish: { icon: 'ğŸŸ', isPassable: true, reward: { coins: 30 } },
  bone: { icon: 'ğŸ¦´', isPassable: true, reward: { coins: 30 } },
  start: { icon: 'ğŸ±', isPassable: true },
  exit: { icon: 'ğŸšª', isPassable: true },
  obstacle: { icon: 'ğŸª¨', isPassable: false },
};

function initExploreGame() {
  // å¦‚æœæ˜¯æ–°æ¸¸æˆï¼Œé‡ç½®æ‰€æœ‰çŠ¶æ€
  if (exploreGameStatus === 'idle' || exploreGameStatus === 'lost') {
    exploreLevel = 1;
    exploreLives = 3;
    exploreCoins = 0;
    exploreGems = 0;
    exploreItems = { maps: 1, picks: 1 };
  }

  // é‡ç½®å…³å¡ç»Ÿè®¡
  exploreStats = {
    cellsRevealed: 0,
    treasuresCollected: 0,
    trapsHit: 0,
    levelStartCoins: exploreCoins,
    levelStartGems: exploreGems
  };

  exploreFlagMode = false;
  exploreGameStatus = 'playing';

  // ç”Ÿæˆå¯è§£ç½‘æ ¼
  let attempts = 0;
  do {
    generateExploreGrid();
    attempts++;
  } while (!isExploreSolvable() && attempts < 100);

  if (attempts >= 100) {
    console.warn('Failed to generate solvable grid, using last attempt');
  }

  gameState = 'playing';
}

function generateExploreGrid() {
  const size = EXPLORE_LEVELS.getSize(exploreLevel);
  const trapCount = EXPLORE_LEVELS.getTraps(exploreLevel);
  const treasureCount = EXPLORE_LEVELS.getTreasures(exploreLevel);

  // åˆ›å»ºç©ºç½‘æ ¼
  exploreGrid = [];
  for (let r = 0; r < size; r++) {
    exploreGrid[r] = [];
    for (let c = 0; c < size; c++) {
      exploreGrid[r][c] = {
        type: 'empty',
        revealed: false,
        flagged: false,
        adjacentTraps: 0,
      };
    }
  }

  // æ”¾ç½®å…¥å£å’Œå‡ºå£
  exploreStartPos = { row: size - 1, col: 0 };
  exploreExitPos = { row: 0, col: size - 1 };
  exploreGrid[exploreStartPos.row][exploreStartPos.col].type = 'start';
  exploreGrid[exploreStartPos.row][exploreStartPos.col].revealed = true;
  exploreGrid[exploreExitPos.row][exploreExitPos.col].type = 'exit';

  // æ”¾ç½®é™·é˜±ï¼ˆé¿å¼€å…¥å£ã€å‡ºå£åŠå…¶å‘¨å›´ï¼‰
  let trapsPlaced = 0;
  while (trapsPlaced < trapCount) {
    const r = Math.floor(Math.random() * size);
    const c = Math.floor(Math.random() * size);
    if (canPlaceTrap(r, c, size)) {
      exploreGrid[r][c].type = 'trap';
      trapsPlaced++;
    }
  }

  // æ”¾ç½®å®ç‰©
  const treasureTypes = ['treasure', 'gem', 'acorn', 'fish', 'bone'];
  let treasuresPlaced = 0;
  while (treasuresPlaced < treasureCount) {
    const r = Math.floor(Math.random() * size);
    const c = Math.floor(Math.random() * size);
    if (exploreGrid[r][c].type === 'empty') {
      exploreGrid[r][c].type = treasureTypes[treasuresPlaced % treasureTypes.length];
      treasuresPlaced++;
    }
  }

  // è®¡ç®—æ•°å­—æç¤º
  calculateExploreNumbers();
}

function canPlaceTrap(r, c, size) {
  const cell = exploreGrid[r][c];
  if (cell.type !== 'empty') return false;

  // ä¸èƒ½æ”¾åœ¨å…¥å£æˆ–å‡ºå£é™„è¿‘
  const distToStart = Math.abs(r - exploreStartPos.row) + Math.abs(c - exploreStartPos.col);
  const distToExit = Math.abs(r - exploreExitPos.row) + Math.abs(c - exploreExitPos.col);
  if (distToStart <= 1 || distToExit <= 1) return false;

  return true;
}

function calculateExploreNumbers() {
  const size = exploreGrid.length;
  for (let r = 0; r < size; r++) {
    for (let c = 0; c < size; c++) {
      if (exploreGrid[r][c].type !== 'trap') {
        exploreGrid[r][c].adjacentTraps = countAdjacentTraps(r, c);
      }
    }
  }
}

function countAdjacentTraps(row, col) {
  const size = exploreGrid.length;
  let count = 0;
  for (let dr = -1; dr <= 1; dr++) {
    for (let dc = -1; dc <= 1; dc++) {
      if (dr === 0 && dc === 0) continue;
      const nr = row + dr, nc = col + dc;
      if (nr >= 0 && nr < size && nc >= 0 && nc < size) {
        if (exploreGrid[nr][nc].type === 'trap') count++;
      }
    }
  }
  return count;
}

function isExploreSolvable() {
  // ä½¿ç”¨ BFS æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»å…¥å£åˆ°å‡ºå£çš„å®‰å…¨è·¯å¾„
  const size = exploreGrid.length;
  const visited = new Set();
  const queue = [[exploreStartPos.row, exploreStartPos.col]];

  while (queue.length > 0) {
    const [r, c] = queue.shift();
    const key = `${r},${c}`;
    if (visited.has(key)) continue;
    visited.add(key);

    const cell = exploreGrid[r][c];
    if (cell.type === 'trap' || cell.type === 'obstacle') continue;
    if (r === exploreExitPos.row && c === exploreExitPos.col) return true;

    // å››æ–¹å‘ç§»åŠ¨
    for (const [dr, dc] of [[0, 1], [0, -1], [1, 0], [-1, 0]]) {
      const nr = r + dr, nc = c + dc;
      if (nr >= 0 && nr < size && nc >= 0 && nc < size) {
        queue.push([nr, nc]);
      }
    }
  }
  return false;
}

function renderExploreGame() {
  const area = document.getElementById('gameArea');
  const size = exploreGrid.length;
  const cellSize = Math.min(50, 280 / size);

  // ç”Ÿæˆç”Ÿå‘½æ˜¾ç¤º
  const livesDisplay = 'â¤ï¸'.repeat(exploreLives) + 'ğŸ–¤'.repeat(exploreMaxLives - exploreLives);

  area.innerHTML = `
    <div class="game-header">
      <div class="game-title">ğŸ—ºï¸ ç¬¬${exploreLevel}å±‚</div>
      <div class="game-stats">
        <span class="lives">${livesDisplay}</span>
        <span class="coins">ğŸ’°${exploreCoins}</span>
        <span class="gems">ğŸ’${exploreGems}</span>
      </div>
    </div>
    <div class="game-content">
      <div class="explore-description">
        <div class="text">ä» ğŸ± èµ°åˆ° ğŸšªï¼Œé¿å¼€ ğŸ’€ é™·é˜±ï¼æ•°å­— = å‘¨å›´é™·é˜±æ•°</div>
      </div>
      <div class="explore-grid" style="grid-template-columns: repeat(${size}, ${cellSize}px);">
        ${exploreGrid.map((row, r) => row.map((cell, c) => {
          const typeInfo = EXPLORE_CELL_TYPES[cell.type];
          let content = '';
          let cellClass = 'explore-cell';

          if (cell.revealed) {
            cellClass += ' revealed';
            if (cell.type === 'trap') {
              content = 'ğŸ’€';
              cellClass += ' trap';
            } else if (cell.type === 'exit') {
              content = 'ğŸšª';
              cellClass += ' exit';
            } else if (cell.type === 'start') {
              content = 'ğŸ±';
              cellClass += ' start';
            } else if (typeInfo.icon) {
              content = typeInfo.icon;
              cellClass += ' treasure';
            } else if (cell.adjacentTraps > 0) {
              content = cell.adjacentTraps;
              cellClass += ' number-' + cell.adjacentTraps;
            }
          } else {
            content = cell.flagged ? 'ğŸš©' : 'ğŸŒ¿';
            cellClass += cell.flagged ? ' flagged' : ' hidden';
          }

          return `
            <div class="${cellClass}" style="width:${cellSize}px;height:${cellSize}px;"
                 data-row="${r}" data-col="${c}"
                 onclick="clickExploreCell(${r}, ${c})"
                 oncontextmenu="flagExploreCell(${r}, ${c}); return false;">
              ${content}
            </div>
          `;
        }).join('')).join('')}
      </div>
      <div class="explore-toolbar">
        <button class="tool-btn ${exploreFlagMode ? 'active' : ''}" onclick="toggleFlagMode()">
          ğŸš© æ ‡è®°æ¨¡å¼
        </button>
        <button class="tool-btn" onclick="useExploreMap()" ${exploreItems.maps <= 0 ? 'disabled' : ''}>
          ğŸ—ºï¸ Ã—${exploreItems.maps}
        </button>
        <button class="tool-btn" onclick="useExplorePick()" ${exploreItems.picks <= 0 ? 'disabled' : ''}>
          â›ï¸ Ã—${exploreItems.picks}
        </button>
      </div>
    </div>
  `;
}

function clickExploreCell(row, col) {
  if (exploreGameStatus !== 'playing') return;

  const cell = exploreGrid[row][col];

  // å·²æ­ç¤ºçš„å‡ºå£å¯ä»¥ç‚¹å‡»è¿‡å…³
  if (cell.revealed && cell.type === 'exit') {
    endExploreGame(true);
    return;
  }

  if (cell.revealed) return;

  if (exploreFlagMode) {
    flagExploreCell(row, col);
    return;
  }

  revealExploreCell(row, col);
}

function revealExploreCell(row, col, usePick = false) {
  const cell = exploreGrid[row][col];
  if (cell.revealed || cell.flagged) return;

  cell.revealed = true;
  exploreStats.cellsRevealed++;
  const typeInfo = EXPLORE_CELL_TYPES[cell.type];

  // åŠ¨ç”»æ•ˆæœ
  const cellEl = document.querySelector(`.explore-cell[data-row="${row}"][data-col="${col}"]`);
  if (cellEl) {
    cellEl.classList.add('revealing');
    createDirtParticles(cellEl);
  }

  // å¤„ç†ä¸åŒç±»å‹
  if (cell.type === 'trap' && !usePick) {
    // è¸©åˆ°é™·é˜±
    exploreLives--;
    exploreStats.trapsHit++;
    setTimeout(() => {
      renderExploreGame();
      shakeScreen();
      if (exploreLives <= 0) {
        setTimeout(() => endExploreGame(false), 500);
      }
    }, 300);
  } else if (cell.type === 'exit') {
    // åˆ°è¾¾å‡ºå£
    setTimeout(() => {
      renderExploreGame();
      setTimeout(() => endExploreGame(true), 500);
    }, 300);
  } else {
    // æ”¶é›†å¥–åŠ±
    if (typeInfo.reward) {
      exploreStats.treasuresCollected++;
      if (typeInfo.reward.coins) exploreCoins += typeInfo.reward.coins;
      if (typeInfo.reward.gems) exploreGems += typeInfo.reward.gems;

      // é«˜ä»·å€¼å®ç‰©æ˜¾ç¤ºåä¸½åŠ¨ç”»
      if (cell.type === 'treasure' || cell.type === 'gem') {
        showTreasureCollectAnimation(cell.type, typeInfo);
      } else {
        // æ™®é€šå®ç‰©æ˜¾ç¤ºç®€å•å¼¹å‡º
        setTimeout(() => {
          renderExploreGame();
          const newCell = document.querySelector(`.explore-cell[data-row="${row}"][data-col="${col}"]`);
          if (newCell) {
            const rewardText = typeInfo.reward.coins ? `+${typeInfo.reward.coins}ğŸ’°` : '+1ğŸ’';
            createRewardPopup(newCell, rewardText);
          }
        }, 300);
      }
    } else {
      // ç©ºæ ¼å­ï¼Œå¦‚æœæ•°å­—ä¸º0åˆ™è‡ªåŠ¨å±•å¼€å‘¨å›´
      if (cell.adjacentTraps === 0 && cell.type === 'empty') {
        setTimeout(() => {
          autoRevealAround(row, col);
          renderExploreGame();
        }, 100);
      } else {
        setTimeout(() => renderExploreGame(), 300);
      }
    }
  }
}

// åä¸½çš„å®ç‰©æ”¶é›†åŠ¨ç”»
function showTreasureCollectAnimation(type, typeInfo) {
  const overlay = document.createElement('div');
  overlay.className = 'treasure-collect-overlay';

  const icon = EXPLORE_CELL_TYPES[type].icon;
  const rewardText = typeInfo.reward.coins
    ? `+${typeInfo.reward.coins} é‡‘å¸`
    : '+1 å®çŸ³';

  overlay.innerHTML = `
    <div class="treasure-box">
      <div class="treasure-sparkles"></div>
      <div class="treasure-icon">${icon}</div>
      <div class="treasure-reward">${rewardText}</div>
    </div>
  `;

  document.body.appendChild(overlay);

  // æ·»åŠ é—ªå…‰ç²’å­
  const sparkles = overlay.querySelector('.treasure-sparkles');
  for (let i = 0; i < 12; i++) {
    const sparkle = document.createElement('div');
    sparkle.className = 'sparkle';
    const angle = (Math.PI * 2 / 12) * i;
    const distance = 60 + Math.random() * 40;
    sparkle.style.setProperty('--sx', `${Math.cos(angle) * distance}px`);
    sparkle.style.setProperty('--sy', `${Math.sin(angle) * distance}px`);
    sparkle.style.left = '50%';
    sparkle.style.top = '50%';
    sparkle.style.animationDelay = `${i * 0.05}s`;
    sparkles.appendChild(sparkle);
  }

  // ç‚¹å‡»æˆ–è‡ªåŠ¨å…³é—­
  const closeOverlay = () => {
    overlay.style.animation = 'overlay-fade-in 0.2s ease-out reverse';
    setTimeout(() => {
      overlay.remove();
      renderExploreGame();
    }, 200);
  };

  overlay.addEventListener('click', closeOverlay);
  setTimeout(closeOverlay, 1500);
}

function autoRevealAround(row, col) {
  const size = exploreGrid.length;
  for (let dr = -1; dr <= 1; dr++) {
    for (let dc = -1; dc <= 1; dc++) {
      if (dr === 0 && dc === 0) continue;
      const nr = row + dr, nc = col + dc;
      if (nr >= 0 && nr < size && nc >= 0 && nc < size) {
        const neighbor = exploreGrid[nr][nc];
        if (!neighbor.revealed && neighbor.type !== 'trap') {
          neighbor.revealed = true;
          if (neighbor.adjacentTraps === 0 && neighbor.type === 'empty') {
            autoRevealAround(nr, nc);
          }
        }
      }
    }
  }
}

function flagExploreCell(row, col) {
  const cell = exploreGrid[row][col];
  if (cell.revealed) return;
  cell.flagged = !cell.flagged;
  renderExploreGame();
}

function toggleFlagMode() {
  exploreFlagMode = !exploreFlagMode;
  renderExploreGame();
}

function useExploreMap() {
  if (exploreItems.maps <= 0) return;
  exploreItems.maps--;

  // æ­ç¤ºä¸€ä¸ª3x3åŒºåŸŸï¼ˆå®‰å…¨çš„ï¼‰
  const size = exploreGrid.length;
  let bestSpot = null;
  let maxHidden = 0;

  // æ‰¾åˆ°éšè—æ ¼å­æœ€å¤šçš„3x3åŒºåŸŸ
  for (let r = 0; r < size - 2; r++) {
    for (let c = 0; c < size - 2; c++) {
      let hidden = 0;
      for (let dr = 0; dr < 3; dr++) {
        for (let dc = 0; dc < 3; dc++) {
          if (!exploreGrid[r + dr][c + dc].revealed) hidden++;
        }
      }
      if (hidden > maxHidden) {
        maxHidden = hidden;
        bestSpot = { row: r, col: c };
      }
    }
  }

  if (bestSpot) {
    for (let dr = 0; dr < 3; dr++) {
      for (let dc = 0; dc < 3; dc++) {
        const cell = exploreGrid[bestSpot.row + dr][bestSpot.col + dc];
        if (!cell.revealed && cell.type !== 'trap') {
          cell.revealed = true;
        }
      }
    }
  }

  renderExploreGame();
}

function useExplorePick() {
  if (exploreItems.picks <= 0) return;
  // æ¿€æ´»é•å­æ¨¡å¼ï¼Œä¸‹æ¬¡ç‚¹å‡»å®‰å…¨æŒ–æ˜
  alert('ç‚¹å‡»ä»»æ„æ ¼å­å®‰å…¨æŒ–æ˜ï¼ˆä¸ä¼šè§¦å‘é™·é˜±ï¼‰');
  exploreItems.picks--;

  // ä¸´æ—¶è¦†ç›–ç‚¹å‡»äº‹ä»¶
  window.pickModeActive = true;
  const originalClick = window.clickExploreCell;
  window.clickExploreCell = (row, col) => {
    if (window.pickModeActive) {
      window.pickModeActive = false;
      revealExploreCell(row, col, true); // usePick = true
    } else {
      originalClick(row, col);
    }
  };
}

function shakeScreen() {
  const container = document.querySelector('.minigame-container');
  if (container) {
    container.classList.add('shake');
    setTimeout(() => container.classList.remove('shake'), 500);
  }
}

function createDirtParticles(cell) {
  for (let i = 0; i < 6; i++) {
    const particle = document.createElement('div');
    particle.className = 'dirt-particle';
    const angle = (Math.PI * 2 / 6) * i + (Math.random() - 0.5) * 0.5;
    const distance = 10 + Math.random() * 10;
    particle.style.setProperty('--dx', `${Math.cos(angle) * distance}px`);
    particle.style.setProperty('--dy', `${Math.sin(angle) * distance - 8}px`);
    particle.style.left = '50%';
    particle.style.top = '50%';
    particle.style.background = ['#228B22', '#1a6b1a', '#2a9b2a'][Math.floor(Math.random() * 3)];
    cell.appendChild(particle);
    setTimeout(() => particle.remove(), 500);
  }
}

function createRewardPopup(cell, text) {
  const popup = document.createElement('div');
  popup.className = 'reward-popup';
  popup.textContent = text;
  cell.appendChild(popup);
  setTimeout(() => popup.remove(), 1000);
}

function endExploreGame(reachedExit) {
  if (reachedExit) {
    // é€šå…³
    exploreLevel++;
    exploreLives = exploreMaxLives; // æ¢å¤ç”Ÿå‘½

    // æ¯5å…³è¿›å…¥å•†åº—
    if (exploreLevel % 5 === 1 && exploreLevel > 1) {
      exploreGameStatus = 'shopping';
      showExploreShop();
    } else {
      // ç»§ç»­ä¸‹ä¸€å…³
      showExploreResult(true);
    }
  } else {
    // æ¸¸æˆç»“æŸ
    exploreGameStatus = 'lost';
    showExploreResult(false);
  }
}

function showExploreResult(success) {
  const modal = document.getElementById('resultModal');
  const content = modal.querySelector('.result-content');

  // è®¡ç®—æœ¬å…³è·å¾—çš„å¥–åŠ±
  const levelCoins = exploreCoins - exploreStats.levelStartCoins;
  const levelGems = exploreGems - exploreStats.levelStartGems;

  // è®¡ç®—æ˜Ÿçº§ï¼ˆåŸºäºè¡¨ç°ï¼‰
  let stars = 1;
  if (success) {
    stars = 1;
    if (exploreStats.trapsHit === 0) stars++; // æ²¡è¸©é™·é˜±åŠ ä¸€æ˜Ÿ
    if (exploreStats.treasuresCollected >= 2) stars++; // æ”¶é›†2ä¸ªä»¥ä¸Šå®ç‰©åŠ ä¸€æ˜Ÿ
  }

  const completedLevel = success ? exploreLevel - 1 : exploreLevel;
  const modalClass = success ? 'victory-modal' : 'victory-modal defeat-modal';
  const btnClass = success ? 'victory-btn' : 'victory-btn defeat-btn';

  content.innerHTML = `
    <div class="${modalClass}">
      <div class="victory-title">${success ? 'ğŸ‰ æ¢ç´¢æˆåŠŸ!' : 'ğŸ’€ æ¢ç´¢å¤±è´¥'}</div>
      <div class="victory-level">ç¬¬ ${completedLevel} å±‚${success ? ' é€šè¿‡' : ''}</div>

      ${success ? `
        <div class="victory-stars">
          <span class="victory-star ${stars >= 1 ? '' : 'empty'}">â­</span>
          <span class="victory-star ${stars >= 2 ? '' : 'empty'}">â­</span>
          <span class="victory-star ${stars >= 3 ? '' : 'empty'}">â­</span>
        </div>
      ` : ''}

      <div class="victory-stats">
        <div class="stat-item">
          <div class="stat-value" data-target="${exploreStats.cellsRevealed}">0</div>
          <div class="stat-label">æŒ–æ˜æ ¼å­</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" data-target="${exploreStats.treasuresCollected}">0</div>
          <div class="stat-label">æ”¶é›†å®ç‰©</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" data-target="${exploreStats.trapsHit}">0</div>
          <div class="stat-label">è¸©ä¸­é™·é˜±</div>
        </div>
      </div>

      <div class="victory-rewards">
        <div class="reward-row">
          <span>ğŸ’°</span>
          <span>+${levelCoins} é‡‘å¸</span>
          <span style="color:#888">(æ€»è®¡: ${exploreCoins})</span>
        </div>
        ${levelGems > 0 ? `
          <div class="reward-row">
            <span>ğŸ’</span>
            <span>+${levelGems} å®çŸ³</span>
            <span style="color:#888">(æ€»è®¡: ${exploreGems})</span>
          </div>
        ` : ''}
        ${success ? `
          <div class="reward-row">
            <span>â¤ï¸</span>
            <span>ç”Ÿå‘½å·²æ¢å¤</span>
            <span style="color:#888">(${exploreLives}/${exploreMaxLives})</span>
          </div>
        ` : ''}
      </div>

      <button class="${btnClass}" onclick="continueExplore(${success})">
        ${success ? 'ç»§ç»­æ¢ç´¢ â†’' : 'é‡æ–°å¼€å§‹'}
      </button>
    </div>
  `;

  modal.classList.add('show');

  // æ•°å­—åŠ¨ç”»å¢é•¿æ•ˆæœ
  setTimeout(() => {
    const statValues = content.querySelectorAll('.stat-value[data-target]');
    statValues.forEach(el => {
      const target = parseInt(el.dataset.target);
      animateNumber(el, 0, target, 800);
    });
  }, 500);
}

// æ•°å­—åŠ¨ç”»å¢é•¿
function animateNumber(element, start, end, duration) {
  const startTime = performance.now();
  const animate = (currentTime) => {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    // ç¼“åŠ¨å‡½æ•°
    const easeOut = 1 - Math.pow(1 - progress, 3);
    const current = Math.round(start + (end - start) * easeOut);
    element.textContent = current;
    if (progress < 1) {
      element.classList.add('counting');
      requestAnimationFrame(animate);
    } else {
      element.classList.remove('counting');
    }
  };
  requestAnimationFrame(animate);
}

function showExploreShop() {
  const modal = document.getElementById('resultModal');
  const content = modal.querySelector('.result-content');

  content.innerHTML = `
    <div class="result-icon">ğŸª</div>
    <div class="result-title">æ£®æ—å•†åº—</div>
    <div class="shop-items">
      <div class="shop-item" onclick="buyExploreItem('map')">
        <span class="item-icon">ğŸ—ºï¸</span>
        <span class="item-name">åœ°å›¾</span>
        <span class="item-price">50ğŸ’°</span>
      </div>
      <div class="shop-item" onclick="buyExploreItem('pick')">
        <span class="item-icon">â›ï¸</span>
        <span class="item-name">é•å­</span>
        <span class="item-price">80ğŸ’°</span>
      </div>
      <div class="shop-item" onclick="buyExploreItem('life')">
        <span class="item-icon">â¤ï¸</span>
        <span class="item-name">ç”Ÿå‘½+1</span>
        <span class="item-price">150ğŸ’°</span>
      </div>
    </div>
    <div class="shop-balance">ä½™é¢: ğŸ’°${exploreCoins}</div>
    <button class="result-btn" onclick="continueExplore(true)">ç»§ç»­æ¢ç´¢</button>
  `;

  modal.classList.add('show');
}

function buyExploreItem(item) {
  const prices = { map: 50, pick: 80, life: 150 };
  const price = prices[item];

  if (exploreCoins < price) {
    alert('é‡‘å¸ä¸è¶³ï¼');
    return;
  }

  exploreCoins -= price;
  if (item === 'map') exploreItems.maps++;
  else if (item === 'pick') exploreItems.picks++;
  else if (item === 'life') exploreMaxLives++;

  showExploreShop(); // åˆ·æ–°å•†åº—æ˜¾ç¤º
}

function continueExplore(success) {
  const modal = document.getElementById('resultModal');
  modal.classList.remove('show');

  if (success) {
    initExploreGame();
    renderExploreGame();
  } else {
    exploreGameStatus = 'idle';
    gameState = 'idle';
    renderGameArea();
  }
}

// ============================================
// UI Functions
// ============================================
function selectGame(game) {
  if (gameState === 'playing') return;

  currentGame = game;
  document.querySelectorAll('.game-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.game === game);
  });
  renderGameArea();
}

function renderGameArea() {
  const area = document.getElementById('gameArea');

  if (gameState === 'idle') {
    let title, desc, icon;
    switch (currentGame) {
      case 'sort':
        icon = 'ğŸª£';
        title = 'æ”¶é›†æ•´ç†';
        desc = 'å¸®çŒ«ç‹—æ•´ç†æ”¶é›†çš„æ£®æ—ç‰©å“ï¼æ¯ä¸ªæœ¨æ¡¶åªæ”¾åŒä¸€ç§å®è´';
        break;
      case 'rescue':
        icon = 'ğŸ±';
        title = 'æ£®æ—æ•‘æ´';
        desc = 'å¸®åŠ©è¢«å›°çš„ Mochi æˆ– Taro è„±ç¦»å›°å¢ƒï¼æŒ‰æ­£ç¡®é¡ºåºç§»é™¤éšœç¢ç‰©';
        break;
      case 'explore':
        icon = 'ğŸ—ºï¸';
        title = 'æ£®æ—æ¢ç´¢';
        desc = 'æ‰«é›·å¼å†’é™©ï¼ä»å…¥å£èµ°åˆ°å‡ºå£ï¼Œç”¨æ•°å­—æ¨ç†é¿å¼€é™·é˜±';
        break;
    }

    area.innerHTML = `
      <div class="game-header">
        <div class="game-title">${icon} ${title}</div>
      </div>
      <div class="game-content">
        <div style="text-align: center;">
          <div style="font-size: 64px; margin-bottom: 20px;">${CHARACTERS.cat.icon}${CHARACTERS.dog.icon}</div>
          <p style="margin-bottom: 30px; opacity: 0.9; max-width: 280px;">${desc}</p>
          <button class="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
        </div>
      </div>
    `;
  } else {
    renderActiveGame();
  }
}

function renderActiveGame() {
  switch (currentGame) {
    case 'sort':
      renderSortGame();
      break;
    case 'rescue':
      renderRescueGame();
      break;
    case 'explore':
      renderExploreGame();
      break;
  }
}

function startGame() {
  switch (currentGame) {
    case 'sort':
      initSortGame('easy');
      break;
    case 'rescue':
      initRescueGame();
      break;
    case 'explore':
      initExploreGame();
      break;
  }
  renderActiveGame();
}

function showResult(success, rewards) {
  const modal = document.getElementById('resultModal');
  const icon = document.getElementById('resultIcon');
  const title = document.getElementById('resultTitle');
  const rewardsDiv = document.getElementById('resultRewards');

  icon.textContent = success ? 'ğŸ‰' : 'ğŸ˜…';
  title.textContent = success ? (rewards.message || 'æˆåŠŸ!') : 'å†è¯•ä¸€æ¬¡';

  let rewardsHtml = '';
  if (rewards.coins) {
    rewardsHtml += `<div class="result-reward"><div class="value">+${rewards.coins}</div><div class="label">é‡‘å¸</div></div>`;
  }
  if (rewards.gems) {
    rewardsHtml += `<div class="result-reward"><div class="value">+${rewards.gems}</div><div class="label">å®çŸ³</div></div>`;
  }
  if (rewards.booster) {
    rewardsHtml += `<div class="result-reward"><div class="value">+1</div><div class="label">${rewards.booster}</div></div>`;
  }

  rewardsDiv.innerHTML = rewardsHtml || '<div class="result-reward"><div class="value">+0</div><div class="label">å¥–åŠ±</div></div>';

  modal.classList.add('show');
  totalPlayed++;
  document.getElementById('stats').textContent = `å·²ç©: ${totalPlayed}`;
}

function closeResult() {
  document.getElementById('resultModal').classList.remove('show');
  gameState = 'idle';
  if (rescueTimer) {
    clearInterval(rescueTimer);
    rescueTimer = null;
  }
  renderGameArea();
}

// Initialize
renderGameArea();
</script>
</body>
</html>
