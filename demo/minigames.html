<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ç¯ç¬¼å¶å­æ¶ˆæ¶ˆä¹ - è¿·ä½ æ¸¸æˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #2d5a27 0%, #1a3518 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #fff;
      overflow-x: hidden;
    }
    .container {
      width: 100%;
      max-width: 540px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .back-btn {
      background: rgba(0,0,0,0.3);
      border: none;
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }
    .back-btn:hover { background: rgba(0,0,0,0.5); }
    h1 {
      font-size: 24px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .stats {
      background: rgba(0,0,0,0.3);
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 12px;
    }

    /* Game Selector */
    .game-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .game-tab {
      flex: 1;
      padding: 15px 10px;
      background: rgba(255,255,255,0.1);
      border: 2px solid transparent;
      border-radius: 15px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }
    .game-tab:hover { background: rgba(255,255,255,0.2); }
    .game-tab.active {
      background: rgba(255,255,255,0.25);
      border-color: #FFD700;
    }
    .game-tab .icon { font-size: 32px; margin-bottom: 5px; }
    .game-tab .name { font-size: 12px; }

    /* Game Area */
    .game-area {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .game-title { font-size: 18px; font-weight: bold; }
    .game-timer {
      font-size: 20px;
      font-weight: bold;
      color: #FFD700;
    }
    .game-timer.warning { color: #ff6b6b; animation: blink 0.5s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }

    .game-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* ============================================ */
    /* Collection Sort Game (æ”¶é›†æ•´ç†) */
    /* ============================================ */
    .sort-description {
      text-align: center;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
    }
    .sort-description .characters {
      font-size: 32px;
      margin-bottom: 5px;
    }
    .sort-description .text {
      font-size: 14px;
      opacity: 0.9;
    }
    .barrels-container {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
    }
    .barrel {
      width: 70px;
      min-height: 180px;
      display: flex;
      flex-direction: column-reverse;
      align-items: center;
      padding: 8px 5px;
      background: linear-gradient(180deg, #8B4513 0%, #654321 50%, #5D3A1A 100%);
      border: 3px solid #5D3A1A;
      border-radius: 10px 10px 15px 15px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      box-shadow: inset 0 -10px 20px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.3);
    }
    .barrel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 15px;
      background: linear-gradient(180deg, #A0522D 0%, #8B4513 100%);
      border-radius: 8px 8px 0 0;
    }
    .barrel::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 10px;
      background: #4A3520;
      border-radius: 0 0 10px 10px;
    }
    .barrel:hover:not(.empty) {
      transform: translateY(-5px);
      box-shadow: inset 0 -10px 20px rgba(0,0,0,0.3), 0 10px 25px rgba(0,0,0,0.4);
    }
    .barrel.selected {
      border-color: #FFD700;
      box-shadow: inset 0 -10px 20px rgba(0,0,0,0.3), 0 0 20px rgba(255,215,0,0.5);
    }
    .barrel.empty {
      background: linear-gradient(180deg, #6B4513 0%, #4A3520 50%, #3D2A1A 100%);
      opacity: 0.7;
    }
    .barrel.complete {
      border-color: #4CAF50;
      box-shadow: inset 0 -10px 20px rgba(0,0,0,0.3), 0 0 20px rgba(76,175,80,0.5);
    }
    .barrel .item {
      width: 50px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-top: 4px;
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      animation: itemDrop 0.3s ease-out;
    }
    @keyframes itemDrop {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .barrel .item.moving {
      animation: itemMove 0.3s ease-out;
    }
    @keyframes itemMove {
      0% { transform: scale(1); }
      50% { transform: scale(1.2) translateY(-10px); }
      100% { transform: scale(1); }
    }
    .sort-info {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      font-size: 14px;
    }
    .sort-info span {
      background: rgba(0,0,0,0.2);
      padding: 8px 15px;
      border-radius: 20px;
    }
    .sort-rule {
      margin-top: 12px;
      padding: 8px 15px;
      background: rgba(255,215,0,0.15);
      border: 1px solid rgba(255,215,0,0.3);
      border-radius: 10px;
      font-size: 12px;
      color: #FFD700;
      text-align: center;
    }
    .sort-rule strong {
      color: #fff;
    }
    .sort-hints {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .hint-btn {
      padding: 10px 15px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .hint-btn:hover { background: rgba(255,255,255,0.25); }
    .hint-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .hint-btn .icon { margin-right: 5px; }

    /* ============================================ */
    /* Forest Rescue Game (æ£®æ—æ•‘æ´) */
    /* ============================================ */
    .rescue-scene {
      text-align: center;
      margin-bottom: 20px;
      position: relative;
    }
    .rescue-visual {
      position: relative;
      width: 280px;
      height: 200px;
      margin: 0 auto 15px;
      background: linear-gradient(180deg, #87CEEB 0%, #98D8AA 50%, #654321 100%);
      border-radius: 15px;
      overflow: hidden;
    }
    .rescue-character {
      position: absolute;
      font-size: 50px;
      transition: all 0.5s ease;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
    }
    .rescue-character.scared {
      animation: scared 0.5s ease-in-out infinite;
    }
    .rescue-character.happy {
      animation: happy 0.3s ease-in-out 3;
    }
    .rescue-character.sad {
      animation: sad 0.5s ease-in-out;
    }
    @keyframes scared {
      0%, 100% { transform: translateX(-2px) rotate(-2deg); }
      50% { transform: translateX(2px) rotate(2deg); }
    }
    @keyframes happy {
      0%, 100% { transform: scale(1) rotate(0); }
      50% { transform: scale(1.2) rotate(10deg); }
    }
    @keyframes sad {
      0% { transform: translateY(0); }
      50% { transform: translateY(10px); }
      100% { transform: translateY(0); }
    }
    .rescue-obstacle {
      position: absolute;
      font-size: 35px;
      cursor: pointer;
      transition: all 0.3s;
      filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3));
    }
    .rescue-obstacle:hover {
      transform: scale(1.1);
      filter: brightness(1.2) drop-shadow(0 0 10px rgba(255,255,255,0.5));
    }
    .rescue-obstacle.removed {
      animation: obstacleRemove 0.5s ease-out forwards;
    }
    @keyframes obstacleRemove {
      to { opacity: 0; transform: scale(0) rotate(180deg); }
    }
    .rescue-element {
      position: absolute;
      font-size: 25px;
      pointer-events: none;
    }
    .rescue-element.falling {
      animation: elementFall 0.8s ease-in forwards;
    }
    @keyframes elementFall {
      to { transform: translateY(100px); opacity: 0; }
    }
    .rescue-lure {
      position: absolute;
      font-size: 30px;
      cursor: pointer;
      animation: lureFloat 1s ease-in-out infinite;
    }
    @keyframes lureFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    .rescue-description {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }
    .countdown-ring {
      position: relative;
      width: 80px;
      height: 80px;
      margin: 0 auto 15px;
    }
    .countdown-ring svg {
      transform: rotate(-90deg);
      width: 80px;
      height: 80px;
    }
    .countdown-ring circle {
      fill: none;
      stroke-width: 6;
    }
    .countdown-ring .bg { stroke: rgba(255,255,255,0.2); }
    .countdown-ring .progress {
      stroke: #FFD700;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s linear;
    }
    .countdown-ring .progress.warning { stroke: #ff6b6b; }
    .countdown-ring .time {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 22px;
      font-weight: bold;
    }

    /* ============================================ */
    /* Forest Explore Game (æ£®æ—æ¢ç´¢) */
    /* ============================================ */
    .explore-description {
      text-align: center;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
    }
    .explore-description .characters {
      font-size: 32px;
      margin-bottom: 5px;
    }
    .explore-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 20px;
      position: relative;
    }
    .explore-cell {
      width: 55px;
      height: 55px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: linear-gradient(145deg, #228B22, #1a6b1a);
      border: 2px solid #165016;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: inset 0 -2px 4px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }
    .explore-cell::before {
      content: 'ğŸŒ¿';
      font-size: 20px;
      opacity: 0.6;
    }
    .explore-cell:hover:not(.revealed) {
      background: linear-gradient(145deg, #2a9b2a, #1f7f1f);
      transform: scale(1.05);
    }
    .explore-cell.revealed {
      background: linear-gradient(145deg, #D2B48C, #C4A47C);
      border-color: #A08060;
      cursor: default;
    }
    .explore-cell.revealed::before { content: none; }
    .explore-cell.digging {
      animation: dig-shake 0.3s ease-out;
    }
    @keyframes dig-shake {
      0%, 100% { transform: rotate(0); }
      25% { transform: rotate(-5deg) scale(0.95); }
      50% { transform: rotate(5deg) scale(0.95); }
      75% { transform: rotate(-3deg); }
    }
    .explore-cell .dirt-particle {
      position: absolute;
      width: 6px;
      height: 6px;
      background: #654321;
      border-radius: 50%;
      pointer-events: none;
      animation: dirt-spray 0.6s ease-out forwards;
    }
    @keyframes dirt-spray {
      0% { opacity: 1; transform: translate(0, 0) scale(1); }
      100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.3); }
    }
    .explore-cell.treasure {
      background: linear-gradient(145deg, #FFD700, #FFA500);
      border-color: #FF8C00;
      animation: treasure-glow 1s infinite, treasure-bounce 0.5s ease-out;
    }
    @keyframes treasure-glow {
      0%, 100% { box-shadow: 0 0 10px #FFD700; }
      50% { box-shadow: 0 0 25px #FFD700, 0 0 40px #FFA500; }
    }
    @keyframes treasure-bounce {
      0% { transform: scale(0.5) rotate(-10deg); }
      50% { transform: scale(1.3) rotate(5deg); }
      75% { transform: scale(0.9) rotate(-2deg); }
      100% { transform: scale(1) rotate(0); }
    }
    .explore-cell .hint-number {
      position: absolute;
      font-size: 16px;
      font-weight: bold;
      color: #333;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
    }
    .explore-cell.hint-cold { box-shadow: inset 0 0 15px rgba(100, 150, 255, 0.5); }
    .explore-cell.hint-warm { box-shadow: inset 0 0 15px rgba(255, 200, 100, 0.5); }
    .explore-cell.hint-hot { box-shadow: inset 0 0 15px rgba(255, 100, 50, 0.7); }
    .explore-cell.hint-fire {
      box-shadow: inset 0 0 20px rgba(255, 50, 0, 0.8);
      animation: fire-pulse 0.5s ease-in-out infinite;
    }
    @keyframes fire-pulse {
      0%, 100% { box-shadow: inset 0 0 15px rgba(255, 50, 0, 0.6); }
      50% { box-shadow: inset 0 0 25px rgba(255, 100, 0, 0.9); }
    }
    .explore-cell .reward-popup {
      position: absolute;
      font-size: 12px;
      font-weight: bold;
      color: #FFD700;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      animation: reward-float 1s ease-out forwards;
      pointer-events: none;
    }
    @keyframes reward-float {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-30px) scale(1.2); }
    }
    .explore-info {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      font-size: 14px;
    }
    .explore-info .item {
      background: rgba(0,0,0,0.2);
      padding: 8px 15px;
      border-radius: 20px;
      transition: transform 0.2s;
    }
    .explore-info .item.pulse {
      animation: info-pulse 0.3s ease-out;
    }
    @keyframes info-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .explore-abilities {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .ability-btn {
      padding: 10px 15px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .ability-btn:hover { background: rgba(255,255,255,0.25); }
    .ability-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .ability-btn .icon { margin-right: 5px; }

    /* Result Modal */
    .result-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .result-modal.show { display: flex; }
    .result-content {
      background: linear-gradient(145deg, #3d7a37, #2d5a27);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      min-width: 300px;
      animation: popIn 0.3s ease-out;
    }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .result-icon { font-size: 64px; margin-bottom: 15px; }
    .result-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
    .result-rewards {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .result-reward {
      background: rgba(0,0,0,0.2);
      padding: 10px 20px;
      border-radius: 10px;
    }
    .result-reward .value { font-size: 20px; font-weight: bold; }
    .result-reward .label { font-size: 12px; opacity: 0.8; }
    .result-btn {
      padding: 15px 40px;
      background: linear-gradient(145deg, #FFD700, #FFA500);
      border: none;
      border-radius: 25px;
      color: #333;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    .result-btn:hover { transform: scale(1.05); }

    /* Start Button */
    .start-btn {
      padding: 20px 60px;
      background: linear-gradient(145deg, #FFD700, #FFA500);
      border: none;
      border-radius: 30px;
      color: #333;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255,215,0,0.4);
      transition: all 0.2s;
    }
    .start-btn:hover { transform: scale(1.05); }
    .start-btn:disabled {
      background: #666;
      cursor: not-allowed;
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="back-btn" onclick="location.href='menu.html'">â† è¿”å›</button>
      <h1>ğŸŒ² æ£®æ—è¿·ä½ æ¸¸æˆ</h1>
      <div class="stats" id="stats">å·²ç©: 0</div>
    </div>

    <div class="game-selector">
      <div class="game-tab active" data-game="sort" onclick="selectGame('sort')">
        <div class="icon">ğŸª£</div>
        <div class="name">æ”¶é›†æ•´ç†</div>
      </div>
      <div class="game-tab" data-game="rescue" onclick="selectGame('rescue')">
        <div class="icon">ğŸ±</div>
        <div class="name">æ£®æ—æ•‘æ´</div>
      </div>
      <div class="game-tab" data-game="explore" onclick="selectGame('explore')">
        <div class="icon">ğŸ—ºï¸</div>
        <div class="name">æ£®æ—æ¢ç´¢</div>
      </div>
    </div>

    <div class="game-area" id="gameArea">
      <!-- Game content rendered here -->
    </div>
  </div>

  <div class="result-modal" id="resultModal">
    <div class="result-content">
      <div class="result-icon" id="resultIcon">ğŸ‰</div>
      <div class="result-title" id="resultTitle">æˆåŠŸ!</div>
      <div class="result-rewards" id="resultRewards"></div>
      <button class="result-btn" onclick="closeResult()">ç»§ç»­</button>
    </div>
  </div>

<script>
// ============================================
// æ¸¸æˆå…ƒç´ å®šä¹‰ - ä¸ä¸»æ¸¸æˆä¸€è‡´
// ============================================
const GAME_ELEMENTS = [
  { id: 'leaf', icon: 'ğŸƒ', name: 'å¶å­' },
  { id: 'acorn', icon: 'ğŸŒ°', name: 'æ©¡æœ' },
  { id: 'star', icon: 'â­', name: 'æ˜Ÿå±‘' },
  { id: 'fish', icon: 'ğŸŸ', name: 'é±¼å¹²' },
  { id: 'bone', icon: 'ğŸ¦´', name: 'éª¨å¤´' },
];

const CHARACTERS = {
  cat: { icon: 'ğŸ±', name: 'Mochi', sensesItem: 'fish' },
  dog: { icon: 'ğŸ¶', name: 'Taro', sensesItem: 'bone' },
};

// ============================================
// Game State
// ============================================
let currentGame = 'sort';
let gameState = 'idle'; // idle, playing, complete
let totalPlayed = 0;

// Collection Sort Game State
let sortBarrels = [];
let sortMoves = 0;
let sortMaxMoves = 15;
let sortLayers = 4; // å½“å‰éš¾åº¦çš„å±‚æ•°
let sortTargetBarrels = 3; // éœ€è¦å®Œæˆçš„æ¡¶æ•° (= types)
let sortCurrentElements = []; // å½“å‰æ¸¸æˆä½¿ç”¨çš„å…ƒç´ ç±»å‹
let sortSelectedBarrel = -1;
let sortHintsUsed = {}; // åŠ¨æ€ï¼š{ elementId: boolean }

// Forest Rescue Game State
let rescueScenario = null;
let rescueTimer = null;
let rescueTimeRemaining = 15;
let rescueObstacles = [];
let rescueElementsUsed = [];

// Forest Explore Game State
let exploreGrid = [];
let exploreTreasures = [];
let explorePaws = 6;
let exploreRewards = { coins: 0, gems: 0, boosters: [] };
let exploreAbilities = { cat: true, dog: true };
let exploreHeatmapActive = false;

// ============================================
// Collection Sort Game (æ”¶é›†æ•´ç†)
// ============================================
const SORT_DIFFICULTIES = {
  // æ ‡å‡† Ball Sort éœ€è¦ types + 2 ä¸ªæ¡¶æ‰èƒ½ä¿è¯å¯è§£
  easy: { barrels: 5, types: 3, layers: 3, moves: 15 },   // 3ç§+2ç©ºæ¡¶
  medium: { barrels: 6, types: 4, layers: 4, moves: 20 }, // 4ç§+2ç©ºæ¡¶
  hard: { barrels: 7, types: 5, layers: 4, moves: 28 },   // 5ç§+2ç©ºæ¡¶
};

function initSortGame(difficulty = 'easy') {
  const config = SORT_DIFFICULTIES[difficulty];
  const elements = GAME_ELEMENTS.slice(0, config.types);

  // åˆ›å»ºæœ¨æ¡¶å†…å®¹
  sortBarrels = [];
  const allItems = [];

  // æ¯ç§å…ƒç´ åˆ›å»º layers ä¸ª
  for (const elem of elements) {
    for (let i = 0; i < config.layers; i++) {
      allItems.push({ ...elem });
    }
  }

  // æ‰“ä¹±
  for (let i = allItems.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [allItems[i], allItems[j]] = [allItems[j], allItems[i]];
  }

  // åˆ†é…åˆ°æœ¨æ¡¶ (types ä¸ªæœ‰ç‰©å“ï¼Œå‰©ä½™ä¸ºç©ºæ¡¶)
  const itemsPerBarrel = config.layers;
  for (let i = 0; i < config.types; i++) {
    const barrel = allItems.slice(i * itemsPerBarrel, (i + 1) * itemsPerBarrel);
    sortBarrels.push(barrel);
  }
  // æ·»åŠ ç©ºæ¡¶ (barrels - types ä¸ªï¼Œé€šå¸¸æ˜¯ 2 ä¸ª)
  for (let i = 0; i < config.barrels - config.types; i++) {
    sortBarrels.push([]);
  }

  sortMoves = 0;
  sortMaxMoves = config.moves;
  sortLayers = config.layers; // å½“å‰éš¾åº¦çš„å±‚æ•°
  sortTargetBarrels = config.types; // éœ€è¦å®Œæˆçš„æ¡¶æ•°
  sortCurrentElements = elements; // ä¿å­˜å½“å‰ä½¿ç”¨çš„å…ƒç´ 
  sortSelectedBarrel = -1;
  // åŠ¨æ€åˆå§‹åŒ–æç¤ºçŠ¶æ€ï¼ˆæ¯ç§å…ƒç´ ä¸€ä¸ªæç¤ºæœºä¼šï¼‰
  sortHintsUsed = {};
  elements.forEach(e => sortHintsUsed[e.id] = false);
  gameState = 'playing';
}

function renderSortGame() {
  const area = document.getElementById('gameArea');

  area.innerHTML = `
    <div class="game-header">
      <div class="game-title">ğŸª£ æ”¶é›†æ•´ç†</div>
      <div class="game-timer">æ­¥æ•°: ${sortMoves}/${sortMaxMoves}</div>
    </div>
    <div class="game-content">
      <div class="sort-description">
        <div class="characters">${CHARACTERS.cat.icon} ${CHARACTERS.dog.icon}</div>
        <div class="text">å¸® Mochi å’Œ Taro æ•´ç†æ”¶é›†çš„å®è´ï¼æ¯æ¡¶åªæ”¾åŒä¸€ç§ç‰©å“</div>
      </div>
      <div class="barrels-container">
        ${sortBarrels.map((barrel, i) => {
          const isComplete = barrel.length > 0 && barrel.every(item => item.id === barrel[0].id) && barrel.length === sortLayers;
          const isEmpty = barrel.length === 0;
          const isSelected = sortSelectedBarrel === i;
          return `
            <div class="barrel ${isEmpty ? 'empty' : ''} ${isComplete ? 'complete' : ''} ${isSelected ? 'selected' : ''}"
                 data-index="${i}" onclick="clickBarrel(${i})">
              ${barrel.map((item, j) => `
                <div class="item" style="animation-delay: ${j * 0.05}s">${item.icon}</div>
              `).join('')}
            </div>
          `;
        }).join('')}
      </div>
      <div class="sort-info">
        <span>å®Œæˆ: ${countCompletedBarrels()}/${sortTargetBarrels}</span>
        <span>æ­¥æ•°: ${sortMoves}/${sortMaxMoves}</span>
      </div>
      <div class="sort-rule">
        ğŸ’¡ åªèƒ½æ”¾åˆ°<strong>ç©ºæ¡¶</strong>æˆ–<strong>ç›¸åŒå…ƒç´ </strong>çš„æ¡¶é¡¶
      </div>
      <div class="sort-hints">
        ${sortCurrentElements.map(elem => `
          <button class="hint-btn" onclick="useSortHintFor('${elem.id}')" ${sortHintsUsed[elem.id] ? 'disabled' : ''}>
            é«˜äº®${elem.icon}
          </button>
        `).join('')}
      </div>
    </div>
  `;
}

function clickBarrel(index) {
  if (gameState !== 'playing') return;

  if (sortSelectedBarrel === -1) {
    // é€‰æ‹©æœ¨æ¡¶ï¼ˆå¿…é¡»æœ‰å…ƒç´ ï¼‰
    if (sortBarrels[index].length > 0) {
      sortSelectedBarrel = index;
      renderSortGame();
    }
  } else {
    if (sortSelectedBarrel === index) {
      // å–æ¶ˆé€‰æ‹©
      sortSelectedBarrel = -1;
      renderSortGame();
      return;
    }

    // å°è¯•ç§»åŠ¨
    const fromBarrel = sortBarrels[sortSelectedBarrel];
    const toBarrel = sortBarrels[index];
    const movingItem = fromBarrel[fromBarrel.length - 1];

    // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç§»åŠ¨
    const canMove = toBarrel.length === 0 ||
                    (toBarrel.length < sortLayers && toBarrel[toBarrel.length - 1].id === movingItem.id);

    if (canMove) {
      // æ‰§è¡Œç§»åŠ¨
      fromBarrel.pop();
      toBarrel.push(movingItem);
      sortMoves++;

      // æ£€æŸ¥èƒœåˆ©
      if (checkSortWin()) {
        gameState = 'complete';
        const perfectBonus = sortMoves <= sortMaxMoves * 0.6;
        showResult(true, {
          coins: perfectBonus ? 150 : 100,
          message: perfectBonus ? 'å®Œç¾é€šå…³!' : 'æ•´ç†å®Œæˆ!'
        });
      } else if (sortMoves >= sortMaxMoves) {
        gameState = 'complete';
        showResult(false, { coins: 30 });
      }
    }

    sortSelectedBarrel = -1;
    renderSortGame();
  }
}

function countCompletedBarrels() {
  return sortBarrels.filter(barrel =>
    barrel.length === sortLayers && barrel.every(item => item.id === barrel[0].id)
  ).length;
}

function checkSortWin() {
  // é™¤äº†ç©ºæ¡¶å¤–ï¼Œæ‰€æœ‰æ¡¶éƒ½å®Œæˆ
  const nonEmptyBarrels = sortBarrels.filter(b => b.length > 0);
  return nonEmptyBarrels.every(barrel =>
    barrel.length === sortLayers && barrel.every(item => item.id === barrel[0].id)
  );
}

// æ–°ç‰ˆï¼šé«˜äº®æŒ‡å®šå…ƒç´ ç±»å‹
function useSortHintFor(elementId) {
  if (sortHintsUsed[elementId]) return;
  sortHintsUsed[elementId] = true;

  // å…ˆé‡æ–°æ¸²æŸ“æ›´æ–°æŒ‰é’®çŠ¶æ€
  renderSortGame();

  // ç„¶ååº”ç”¨é«˜äº®æ•ˆæœï¼ˆæ¸²æŸ“åå†åº”ç”¨ï¼Œé¿å…è¢«è¦†ç›–ï¼‰
  setTimeout(() => {
    const barrelElements = document.querySelectorAll('.barrel');
    sortBarrels.forEach((barrel, i) => {
      if (barrel.some(item => item.id === elementId)) {
        barrelElements[i].style.boxShadow = 'inset 0 -10px 20px rgba(0,0,0,0.3), 0 0 20px rgba(255,215,0,0.8)';
        barrelElements[i].style.transition = 'box-shadow 0.3s';
        setTimeout(() => {
          barrelElements[i].style.boxShadow = '';
        }, 2000);
      }
    });
  }, 50);
}

// ============================================
// Forest Rescue Game (æ£®æ—æ•‘æ´)
// ============================================
const RESCUE_SCENARIOS = [
  {
    id: 'cat_tree',
    character: 'cat',
    description: 'Mochi è¢«å›°åœ¨æ ‘ä¸Šï¼æŒ‰æ­£ç¡®é¡ºåºç§»é™¤éšœç¢ç‰©',
    obstacles: [
      { id: 'moss1', icon: 'ğŸŒ¿', type: 'moss', position: { x: 40, y: 80 }, order: 1 },
      { id: 'branch', icon: 'ğŸªµ', type: 'branch', position: { x: 100, y: 50 }, order: 2 },
      { id: 'leaves', icon: 'ğŸƒ', type: 'cushion', position: { x: 70, y: 140 }, order: 3 },
    ],
    characterPos: { x: 100, y: 30 },
    safePos: { x: 100, y: 150 },
    lure: { icon: 'ğŸŸ', position: { x: 140, y: 160 } },
    rewards: { coins: 120, booster: 'rocket' },
  },
  {
    id: 'dog_river',
    character: 'dog',
    description: 'Taro éœ€è¦è¿‡æ²³ï¼æŒ‰æ­£ç¡®é¡ºåºæ­å»ºè·¯å¾„',
    obstacles: [
      { id: 'rock1', icon: 'ğŸª¨', type: 'rock', position: { x: 60, y: 100 }, order: 2 },
      { id: 'moss2', icon: 'ğŸŒ¿', type: 'moss', position: { x: 120, y: 100 }, order: 1 },
      { id: 'acorns', icon: 'ğŸŒ°', type: 'bridge', position: { x: 90, y: 120 }, order: 3 },
    ],
    characterPos: { x: 30, y: 90 },
    safePos: { x: 200, y: 90 },
    lure: { icon: 'ğŸ¦´', position: { x: 220, y: 90 } },
    rewards: { coins: 120, booster: 'bomb' },
  },
  {
    id: 'cat_rain',
    character: 'cat',
    description: 'ä¸‹é›¨äº†ï¼å¸® Mochi æ‰¾åˆ°å¶å­ä¼',
    obstacles: [
      { id: 'star1', icon: 'â­', type: 'light', position: { x: 80, y: 60 }, order: 1 },
      { id: 'leaves2', icon: 'ğŸƒğŸƒ', type: 'umbrella', position: { x: 130, y: 40 }, order: 3 },
      { id: 'moss3', icon: 'ğŸŒ¿', type: 'moss', position: { x: 160, y: 90 }, order: 2 },
    ],
    characterPos: { x: 50, y: 100 },
    safePos: { x: 130, y: 60 },
    lure: { icon: 'ğŸŸ', position: { x: 50, y: 140 } },
    rewards: { coins: 100, gems: 1 },
  },
];

function initRescueGame() {
  rescueScenario = RESCUE_SCENARIOS[Math.floor(Math.random() * RESCUE_SCENARIOS.length)];
  rescueTimeRemaining = 15;
  rescueObstacles = rescueScenario.obstacles.map(o => ({ ...o, removed: false }));
  rescueElementsUsed = [];
  gameState = 'playing';

  rescueTimer = setInterval(() => {
    rescueTimeRemaining--;
    updateRescueTimer();
    if (rescueTimeRemaining <= 0) {
      clearInterval(rescueTimer);
      endRescueGame(false);
    }
  }, 1000);
}

function renderRescueGame() {
  const area = document.getElementById('gameArea');
  const s = rescueScenario;
  const char = CHARACTERS[s.character];
  const circumference = 2 * Math.PI * 35;
  const dashoffset = circumference * (1 - rescueTimeRemaining / 15);

  area.innerHTML = `
    <div class="game-header">
      <div class="game-title">ğŸŒ² æ£®æ—æ•‘æ´</div>
      <div class="countdown-ring">
        <svg>
          <circle class="bg" cx="40" cy="40" r="35"></circle>
          <circle class="progress ${rescueTimeRemaining <= 5 ? 'warning' : ''}"
                  cx="40" cy="40" r="35"
                  style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${dashoffset}">
          </circle>
        </svg>
        <div class="time">${rescueTimeRemaining}</div>
      </div>
    </div>
    <div class="game-content">
      <div class="rescue-description">${s.description}</div>
      <div class="rescue-visual">
        <div class="rescue-character ${gameState === 'playing' ? 'scared' : ''}"
             id="rescueChar"
             style="left: ${s.characterPos.x}px; top: ${s.characterPos.y}px;">
          ${char.icon}
        </div>
        ${rescueObstacles.map(o => `
          <div class="rescue-obstacle ${o.removed ? 'removed' : ''}"
               data-id="${o.id}"
               style="left: ${o.position.x}px; top: ${o.position.y}px;"
               onclick="clickObstacle('${o.id}')">
            ${o.icon}
          </div>
        `).join('')}
        <div class="rescue-lure" style="left: ${s.lure.position.x}px; top: ${s.lure.position.y}px;">
          ${s.lure.icon}
        </div>
      </div>
      <div class="sort-info">
        <span>é¡ºåºæç¤º: ${getOrderHint()}</span>
      </div>
    </div>
  `;
}

function getOrderHint() {
  const remaining = rescueObstacles.filter(o => !o.removed).sort((a, b) => a.order - b.order);
  if (remaining.length === 0) return 'å®Œæˆ!';
  return remaining.map(o => o.icon).join(' â†’ ');
}

function clickObstacle(id) {
  if (gameState !== 'playing') return;

  const obstacle = rescueObstacles.find(o => o.id === id);
  if (!obstacle || obstacle.removed) return;

  // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰åº”è¯¥ç§»é™¤çš„
  const remaining = rescueObstacles.filter(o => !o.removed).sort((a, b) => a.order - b.order);
  const nextObstacle = remaining[0];

  if (obstacle.id === nextObstacle.id) {
    // æ­£ç¡®ï¼
    obstacle.removed = true;
    rescueElementsUsed.push(obstacle);

    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
    if (rescueObstacles.every(o => o.removed)) {
      clearInterval(rescueTimer);
      // ç§»åŠ¨è§’è‰²åˆ°å®‰å…¨ä½ç½®
      setTimeout(() => {
        const charEl = document.getElementById('rescueChar');
        if (charEl) {
          charEl.classList.remove('scared');
          charEl.classList.add('happy');
          charEl.style.left = rescueScenario.safePos.x + 'px';
          charEl.style.top = rescueScenario.safePos.y + 'px';
        }
      }, 300);
      setTimeout(() => endRescueGame(true), 1000);
    }
  } else {
    // é”™è¯¯é¡ºåº - æ‰£æ—¶é—´
    rescueTimeRemaining = Math.max(0, rescueTimeRemaining - 3);
    const el = document.querySelector(`.rescue-obstacle[data-id="${id}"]`);
    if (el) {
      el.style.animation = 'wrong-shake 0.3s';
      setTimeout(() => el.style.animation = '', 300);
    }
  }

  renderRescueGame();
}

function updateRescueTimer() {
  const timeEl = document.querySelector('.countdown-ring .time');
  const progressEl = document.querySelector('.countdown-ring .progress');
  if (timeEl) timeEl.textContent = rescueTimeRemaining;
  if (progressEl) {
    const circumference = 2 * Math.PI * 35;
    progressEl.style.strokeDashoffset = circumference * (1 - rescueTimeRemaining / 15);
    if (rescueTimeRemaining <= 5) progressEl.classList.add('warning');
  }
}

function endRescueGame(success) {
  gameState = 'complete';
  const rewards = success ? rescueScenario.rewards : { coins: 25 };
  showResult(success, rewards);
}

// ============================================
// Forest Explore Game (æ£®æ—æ¢ç´¢)
// ============================================
const EXPLORE_CONTENTS = {
  empty: { icon: 'ğŸƒ', reward: null },
  acorn: { icon: 'ğŸŒ°', reward: { coins: 30 } },
  star: { icon: 'â­', reward: { gems: 1 } },
  fish: { icon: 'ğŸŸ', reward: { coins: 50 } },
  bone: { icon: 'ğŸ¦´', reward: { coins: 50 } },
  trap: { icon: 'ğŸŒ¿ğŸ’€', reward: { paws: -1 } },
  treasure: { icon: 'ğŸ', reward: { coins: 100, gems: 2 } },
};

const EXPLORE_WEIGHTS = {
  empty: 35,
  acorn: 25,
  star: 10,
  fish: 10,
  bone: 10,
  trap: 8,
  treasure: 2,
};

function initExploreGame() {
  exploreGrid = [];
  exploreTreasures = [];
  explorePaws = 6;
  exploreRewards = { coins: 0, gems: 0, boosters: [] };
  exploreAbilities = { cat: true, dog: true };
  exploreHeatmapActive = false;

  // ç”Ÿæˆç½‘æ ¼
  for (let r = 0; r < 5; r++) {
    exploreGrid[r] = [];
    for (let c = 0; c < 5; c++) {
      exploreGrid[r][c] = {
        content: weightedRandom(EXPLORE_WEIGHTS),
        revealed: false,
        flagged: false,
      };
    }
  }

  // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªå®ç®±
  const treasureCount = exploreGrid.flat().filter(cell => cell.content === 'treasure').length;
  if (treasureCount === 0) {
    const r = Math.floor(Math.random() * 5);
    const c = Math.floor(Math.random() * 5);
    exploreGrid[r][c].content = 'treasure';
  }

  // è®°å½•å®ç®±ä½ç½®
  for (let r = 0; r < 5; r++) {
    for (let c = 0; c < 5; c++) {
      if (exploreGrid[r][c].content === 'treasure') {
        exploreTreasures.push({ row: r, col: c });
      }
    }
  }

  gameState = 'playing';
}

function weightedRandom(weights) {
  const total = Object.values(weights).reduce((a, b) => a + b, 0);
  let random = Math.random() * total;
  for (const [key, weight] of Object.entries(weights)) {
    random -= weight;
    if (random <= 0) return key;
  }
  return 'empty';
}

function getDistanceToTreasure(row, col) {
  if (exploreTreasures.length === 0) return 99;
  return Math.min(...exploreTreasures.map(t =>
    Math.abs(t.row - row) + Math.abs(t.col - col)
  ));
}

function renderExploreGame() {
  const area = document.getElementById('gameArea');

  area.innerHTML = `
    <div class="game-header">
      <div class="game-title">ğŸ—ºï¸ æ£®æ—æ¢ç´¢</div>
      <div class="game-timer">ğŸ¾ Ã—${explorePaws}</div>
    </div>
    <div class="game-content">
      <div class="explore-description">
        <div class="characters">${CHARACTERS.cat.icon} ${CHARACTERS.dog.icon}</div>
        <div class="text">åœ¨æ£®æ—ä¸­å¯»æ‰¾éšè—çš„å®è´ï¼æŒ–å¼€è‹”è—“çœ‹çœ‹ä¸‹é¢æœ‰ä»€ä¹ˆ</div>
      </div>
      <div class="explore-grid">
        ${exploreGrid.map((row, r) => row.map((cell, c) => {
          const dist = getDistanceToTreasure(r, c);
          let hintClass = '';
          if (exploreHeatmapActive && !cell.revealed) {
            if (dist === 0) hintClass = 'hint-fire';
            else if (dist === 1) hintClass = 'hint-hot';
            else if (dist <= 2) hintClass = 'hint-warm';
            else hintClass = 'hint-cold';
          }
          const isTreasure = cell.content === 'treasure' && cell.revealed;
          const contentInfo = EXPLORE_CONTENTS[cell.content];
          return `
            <div class="explore-cell ${cell.revealed ? 'revealed' : ''} ${isTreasure ? 'treasure' : ''} ${hintClass}"
                 data-row="${r}" data-col="${c}" onclick="digExploreCell(${r}, ${c})">
              ${cell.revealed ? contentInfo.icon : ''}
              ${cell.revealed && cell.content !== 'empty' && cell.content !== 'trap' && !isTreasure ?
                `<span class="hint-number">${dist}</span>` : ''}
            </div>
          `;
        }).join('')).join('')}
      </div>
      <div class="explore-info">
        <div class="item" id="explore-coins">ğŸ’° ${exploreRewards.coins}</div>
        <div class="item" id="explore-gems">ğŸ’ ${exploreRewards.gems}</div>
      </div>
      <div class="explore-abilities">
        <button class="ability-btn" onclick="useExploreAbility('cat')" ${!exploreAbilities.cat ? 'disabled' : ''}>
          <span class="icon">ğŸ±</span>æ„Ÿåº”ğŸŸ
        </button>
        <button class="ability-btn" onclick="useExploreAbility('dog')" ${!exploreAbilities.dog ? 'disabled' : ''}>
          <span class="icon">ğŸ¶</span>æ„Ÿåº”ğŸ¦´
        </button>
        <button class="ability-btn" onclick="toggleExploreHeatmap()">
          ${exploreHeatmapActive ? 'ğŸ”¥ å…³é—­çƒ­åŠ›å›¾' : 'ğŸ’¡ çƒ­åŠ›å›¾'}
        </button>
      </div>
    </div>
  `;
}

function digExploreCell(row, col) {
  if (gameState !== 'playing') return;
  if (explorePaws <= 0) return;
  if (exploreGrid[row][col].revealed) return;

  const cell = document.querySelector(`.explore-cell[data-row="${row}"][data-col="${col}"]`);
  if (cell) {
    cell.classList.add('digging');
    createDirtParticles(cell);
  }

  explorePaws--;
  exploreGrid[row][col].revealed = true;

  const content = exploreGrid[row][col].content;
  const contentInfo = EXPLORE_CONTENTS[content];

  // å¤„ç†å¥–åŠ±
  let rewardText = '';
  if (contentInfo.reward) {
    if (contentInfo.reward.coins) {
      exploreRewards.coins += contentInfo.reward.coins;
      rewardText = `+${contentInfo.reward.coins}ğŸ’°`;
    }
    if (contentInfo.reward.gems) {
      exploreRewards.gems += contentInfo.reward.gems;
      rewardText = `+${contentInfo.reward.gems}ğŸ’`;
    }
    if (contentInfo.reward.paws) {
      explorePaws += contentInfo.reward.paws;
      rewardText = `${contentInfo.reward.paws}ğŸ¾`;
    }
  }

  setTimeout(() => {
    renderExploreGame();

    if (rewardText && content !== 'empty') {
      const newCell = document.querySelector(`.explore-cell[data-row="${row}"][data-col="${col}"]`);
      if (newCell) createRewardPopup(newCell, rewardText);
    }

    // æ£€æŸ¥ç»“æŸæ¡ä»¶
    if (content === 'treasure') {
      setTimeout(() => endExploreGame(true), 800);
    } else if (explorePaws <= 0) {
      setTimeout(() => endExploreGame(false), 500);
    }
  }, 300);
}

function useExploreAbility(character) {
  const targetItem = character === 'cat' ? 'fish' : 'bone';
  exploreAbilities[character] = false;

  // é«˜äº®ç›¸é‚»æ ¼å­ä¸­æ˜¯å¦æœ‰ç›®æ ‡ç‰©å“
  const cells = document.querySelectorAll('.explore-cell:not(.revealed)');
  cells.forEach(cell => {
    const row = parseInt(cell.dataset.row);
    const col = parseInt(cell.dataset.col);

    // æ£€æŸ¥ç›¸é‚»æ ¼å­
    let hasTarget = false;
    for (let dr = -1; dr <= 1; dr++) {
      for (let dc = -1; dc <= 1; dc++) {
        if (dr === 0 && dc === 0) continue;
        const nr = row + dr;
        const nc = col + dc;
        if (nr >= 0 && nr < 5 && nc >= 0 && nc < 5) {
          if (exploreGrid[nr][nc].content === targetItem && !exploreGrid[nr][nc].revealed) {
            hasTarget = true;
          }
        }
      }
    }

    if (hasTarget) {
      cell.style.boxShadow = 'inset 0 0 20px rgba(255,215,0,0.8)';
      setTimeout(() => cell.style.boxShadow = '', 2000);
    }
  });

  renderExploreGame();
}

function toggleExploreHeatmap() {
  exploreHeatmapActive = !exploreHeatmapActive;
  renderExploreGame();
}

function createDirtParticles(cell) {
  for (let i = 0; i < 8; i++) {
    const particle = document.createElement('div');
    particle.className = 'dirt-particle';
    const angle = (Math.PI * 2 / 8) * i + (Math.random() - 0.5) * 0.5;
    const distance = 15 + Math.random() * 15;
    particle.style.setProperty('--dx', `${Math.cos(angle) * distance}px`);
    particle.style.setProperty('--dy', `${Math.sin(angle) * distance - 10}px`);
    particle.style.left = '50%';
    particle.style.top = '50%';
    particle.style.background = ['#228B22', '#1a6b1a', '#2a9b2a'][Math.floor(Math.random() * 3)];
    cell.appendChild(particle);
    setTimeout(() => particle.remove(), 600);
  }
}

function createRewardPopup(cell, text) {
  const popup = document.createElement('div');
  popup.className = 'reward-popup';
  popup.textContent = text;
  cell.appendChild(popup);
  setTimeout(() => popup.remove(), 1000);
}

function endExploreGame(foundTreasure) {
  gameState = 'complete';
  const rewards = {
    coins: exploreRewards.coins + (foundTreasure ? 50 : 0),
    gems: exploreRewards.gems,
  };
  showResult(foundTreasure, rewards);
}

// ============================================
// UI Functions
// ============================================
function selectGame(game) {
  if (gameState === 'playing') return;

  currentGame = game;
  document.querySelectorAll('.game-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.game === game);
  });
  renderGameArea();
}

function renderGameArea() {
  const area = document.getElementById('gameArea');

  if (gameState === 'idle') {
    let title, desc, icon;
    switch (currentGame) {
      case 'sort':
        icon = 'ğŸª£';
        title = 'æ”¶é›†æ•´ç†';
        desc = 'å¸®çŒ«ç‹—æ•´ç†æ”¶é›†çš„æ£®æ—ç‰©å“ï¼æ¯ä¸ªæœ¨æ¡¶åªæ”¾åŒä¸€ç§å®è´';
        break;
      case 'rescue':
        icon = 'ğŸ±';
        title = 'æ£®æ—æ•‘æ´';
        desc = 'å¸®åŠ©è¢«å›°çš„ Mochi æˆ– Taro è„±ç¦»å›°å¢ƒï¼æŒ‰æ­£ç¡®é¡ºåºç§»é™¤éšœç¢ç‰©';
        break;
      case 'explore':
        icon = 'ğŸ—ºï¸';
        title = 'æ£®æ—æ¢ç´¢';
        desc = 'åœ¨æ£®æ—è‰åœ°ä¸­æŒ–æ˜å¯»æ‰¾éšè—çš„å®ç‰©ï¼ç”¨çˆªå­æŒ–å¼€è‹”è—“';
        break;
    }

    area.innerHTML = `
      <div class="game-header">
        <div class="game-title">${icon} ${title}</div>
      </div>
      <div class="game-content">
        <div style="text-align: center;">
          <div style="font-size: 64px; margin-bottom: 20px;">${CHARACTERS.cat.icon}${CHARACTERS.dog.icon}</div>
          <p style="margin-bottom: 30px; opacity: 0.9; max-width: 280px;">${desc}</p>
          <button class="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
        </div>
      </div>
    `;
  } else {
    renderActiveGame();
  }
}

function renderActiveGame() {
  switch (currentGame) {
    case 'sort':
      renderSortGame();
      break;
    case 'rescue':
      renderRescueGame();
      break;
    case 'explore':
      renderExploreGame();
      break;
  }
}

function startGame() {
  switch (currentGame) {
    case 'sort':
      initSortGame('easy');
      break;
    case 'rescue':
      initRescueGame();
      break;
    case 'explore':
      initExploreGame();
      break;
  }
  renderActiveGame();
}

function showResult(success, rewards) {
  const modal = document.getElementById('resultModal');
  const icon = document.getElementById('resultIcon');
  const title = document.getElementById('resultTitle');
  const rewardsDiv = document.getElementById('resultRewards');

  icon.textContent = success ? 'ğŸ‰' : 'ğŸ˜…';
  title.textContent = success ? (rewards.message || 'æˆåŠŸ!') : 'å†è¯•ä¸€æ¬¡';

  let rewardsHtml = '';
  if (rewards.coins) {
    rewardsHtml += `<div class="result-reward"><div class="value">+${rewards.coins}</div><div class="label">é‡‘å¸</div></div>`;
  }
  if (rewards.gems) {
    rewardsHtml += `<div class="result-reward"><div class="value">+${rewards.gems}</div><div class="label">å®çŸ³</div></div>`;
  }
  if (rewards.booster) {
    rewardsHtml += `<div class="result-reward"><div class="value">+1</div><div class="label">${rewards.booster}</div></div>`;
  }

  rewardsDiv.innerHTML = rewardsHtml || '<div class="result-reward"><div class="value">+0</div><div class="label">å¥–åŠ±</div></div>';

  modal.classList.add('show');
  totalPlayed++;
  document.getElementById('stats').textContent = `å·²ç©: ${totalPlayed}`;
}

function closeResult() {
  document.getElementById('resultModal').classList.remove('show');
  gameState = 'idle';
  if (rescueTimer) {
    clearInterval(rescueTimer);
    rescueTimer = null;
  }
  renderGameArea();
}

// Initialize
renderGameArea();
</script>
</body>
</html>
