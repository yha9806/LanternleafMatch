<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ç¯ç¬¼å¶å­æ¶ˆæ¶ˆä¹ - å…³å¡é€‰æ‹©</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #2d5a27 0%, #1a3518 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #fff;
    }
    .container {
      width: 100%;
      max-width: 540px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* é¡¶éƒ¨æ  */
    .header {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .back-btn {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      text-decoration: none;
    }
    .back-btn:hover { background: rgba(255,255,255,0.3); }
    .header-title {
      flex: 1;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    .header-stats {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
    }
    .stars-icon { color: #FFD700; }
    /* è¿›åº¦æ¡ */
    .progress-bar {
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .progress-track {
      flex: 1;
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      border-radius: 4px;
      transition: width 0.3s;
    }
    .progress-text {
      font-size: 14px;
      min-width: 60px;
      text-align: right;
    }
    /* å…³å¡ç½‘æ ¼ */
    .levels-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .levels-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      padding-bottom: 20px;
    }
    /* å…³å¡æŒ‰é’® */
    .level-btn {
      aspect-ratio: 1;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: transform 0.15s, box-shadow 0.15s;
      position: relative;
    }
    .level-btn:active { transform: scale(0.92); }
    .level-btn.unlocked {
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      color: #fff;
      box-shadow: 0 4px 12px rgba(76,175,80,0.4);
    }
    .level-btn.current {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #333;
      box-shadow: 0 4px 15px rgba(255,215,0,0.5);
      animation: pulse-current 2s infinite;
    }
    @keyframes pulse-current {
      0%, 100% { box-shadow: 0 4px 15px rgba(255,215,0,0.5); }
      50% { box-shadow: 0 4px 25px rgba(255,215,0,0.8); }
    }
    .level-btn.locked {
      background: rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.5);
      cursor: not-allowed;
    }
    .level-btn.locked:active { transform: none; }
    .level-num {
      font-size: 20px;
    }
    .level-stars {
      font-size: 10px;
      margin-top: 2px;
      letter-spacing: -2px;
    }
    .lock-icon {
      font-size: 20px;
    }
    /* åŒºåŸŸåˆ†éš” */
    .region-divider {
      grid-column: 1 / -1;
      padding: 10px 0;
      text-align: center;
      font-size: 14px;
      opacity: 0.7;
      border-top: 1px solid rgba(255,255,255,0.2);
      margin-top: 10px;
    }
    /* åº•éƒ¨ä½“åŠ›æ  */
    .footer {
      padding: 16px 20px;
      background: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }
    .energy-display {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.15);
      padding: 10px 20px;
      border-radius: 25px;
    }
    .energy-icon { font-size: 20px; }
    .energy-value { font-size: 18px; font-weight: bold; }
    .energy-timer { font-size: 12px; opacity: 0.7; }
    /* æç¤ºå¼¹çª— */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 1000;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="container">
    <!-- é¡¶éƒ¨æ  -->
    <div class="header">
      <a href="menu.html" class="back-btn">â†</a>
      <div class="header-title">é€‰æ‹©å…³å¡</div>
      <div class="header-stats">
        <span class="stars-icon">â­</span>
        <span id="totalStars">0</span>
      </div>
    </div>

    <!-- è¿›åº¦æ¡ -->
    <div class="progress-bar">
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="progress-text" id="progressText">0/50</div>
    </div>

    <!-- å…³å¡ç½‘æ ¼ -->
    <div class="levels-scroll" id="levelsScroll">
      <div class="levels-grid" id="levelsGrid"></div>
    </div>

    <!-- åº•éƒ¨ä½“åŠ›æ  -->
    <div class="footer">
      <div class="energy-display">
        <span class="energy-icon">âš¡</span>
        <span class="energy-value" id="energy">5/5</span>
        <span class="energy-timer" id="energyTimer">å·²æ»¡</span>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
// ============================================
// å…³å¡é€‰æ‹©é€»è¾‘
// ============================================

const BASE_LEVELS = 50;  // åŸºç¡€å…³å¡æ•°
const ENERGY_CONFIG = {
  max: 5,
  regenSeconds: 20 * 60,
  newbieProtection: 10
};

// åŒºåŸŸåç§°ï¼ˆåŸºç¡€50å…³ + æ— é™å…³å¡åŒºåŸŸï¼‰
const REGION_NAMES = {
  10: 'ğŸŒ¿ æ–°æ‰‹æ£®æ—',
  20: 'ğŸ‚ ç§‹å¶å°å¾„',
  30: 'ğŸŒ™ æœˆå…‰æ¹–ç•”',
  40: 'ğŸ”ï¸ è¿·é›¾å±±è°·',
  50: 'ğŸ‘‘ ä¼ è¯´ä¹‹åœ°'
};

// æ— é™å…³å¡åŒºåŸŸåç§°
function getInfiniteRegionName(level) {
  const cycle = Math.floor((level - 51) / 25);
  const regions = [
    'ğŸŒŒ æ˜Ÿç©ºç§˜å¢ƒ',
    'ğŸ”¥ çƒˆç„°æ·±æ¸Š',
    'â„ï¸ å†°éœœç‹åº§',
    'ğŸŒ¸ æ¨±èŠ±ä»™å¢ƒ',
    'âš¡ é›·éœ†ä¹‹å·…',
    'ğŸŒŠ æ·±æµ·é—è¿¹',
    'ğŸŒ™ æ°¸å¤œæ£®æ—',
    'â˜€ï¸ é»æ˜åœ£æ®¿'
  ];
  return regions[cycle % regions.length] + ` (${cycle + 1}è½®)`;
}

let playerProgress = {
  currentLevel: 1,
  levelStars: {},
  totalStars: 0,
  completedLevels: 0
};

let energyState = {
  current: 5,
  lastRegenTime: Date.now()
};

// åŠ è½½è¿›åº¦
function loadProgress() {
  try {
    const saved = localStorage.getItem('lanternleaf_player_progress');
    if (saved) {
      const data = JSON.parse(saved);
      playerProgress = {
        currentLevel: data.currentLevel || 1,
        levelStars: data.levelStars || {},
        totalStars: data.totalStars || 0,
        completedLevels: data.completedLevels || 0
      };
    }
  } catch (e) {
    console.log('Failed to load progress:', e);
  }
}

// åŠ è½½ä½“åŠ›
function loadEnergy() {
  try {
    const saved = localStorage.getItem('lanternleaf_energy');
    if (saved) {
      const data = JSON.parse(saved);
      energyState.current = data.current;
      energyState.lastRegenTime = data.lastRegenTime;

      // è®¡ç®—ç¦»çº¿æ¢å¤
      const now = Date.now();
      const elapsed = now - energyState.lastRegenTime;
      const regenPoints = Math.floor(elapsed / (ENERGY_CONFIG.regenSeconds * 1000));
      energyState.current = Math.min(ENERGY_CONFIG.max, energyState.current + regenPoints);
    }
  } catch (e) {
    console.log('Failed to load energy:', e);
  }
}

// æ›´æ–°ä½“åŠ›æ˜¾ç¤º
function updateEnergyDisplay() {
  document.getElementById('energy').textContent =
    `${energyState.current}/${ENERGY_CONFIG.max}`;

  if (energyState.current < ENERGY_CONFIG.max) {
    const elapsed = Date.now() - energyState.lastRegenTime;
    const remaining = (ENERGY_CONFIG.regenSeconds * 1000) -
      (elapsed % (ENERGY_CONFIG.regenSeconds * 1000));
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    document.getElementById('energyTimer').textContent =
      `${minutes}:${seconds.toString().padStart(2, '0')}`;
  } else {
    document.getElementById('energyTimer').textContent = 'å·²æ»¡';
  }
}

// è®¡ç®—æ˜¾ç¤ºçš„æœ€å¤§å…³å¡æ•°ï¼ˆå½“å‰å…³å¡ + 10å…³é¢„è§ˆï¼Œè‡³å°‘æ˜¾ç¤º50å…³ï¼‰
function getMaxDisplayLevel() {
  return Math.max(BASE_LEVELS, playerProgress.currentLevel + 10);
}

// ç”Ÿæˆå…³å¡ç½‘æ ¼
function generateLevelGrid() {
  const grid = document.getElementById('levelsGrid');
  grid.innerHTML = '';

  const maxLevel = getMaxDisplayLevel();
  let lastRegionLevel = 0;

  for (let level = 1; level <= maxLevel; level++) {
    // åŒºåŸŸåˆ†éš”ï¼ˆåŸºç¡€å…³å¡ï¼‰
    if (level <= BASE_LEVELS) {
      if (level === 1 || level === 11 || level === 21 || level === 31 || level === 41) {
        const regionEnd = Math.min(level + 9, BASE_LEVELS);
        const divider = document.createElement('div');
        divider.className = 'region-divider';
        divider.textContent = REGION_NAMES[regionEnd] || '';
        grid.appendChild(divider);
        lastRegionLevel = level;
      }
    } else {
      // æ— é™å…³å¡åŒºåŸŸåˆ†éš”ï¼ˆæ¯25å…³ä¸€ä¸ªåŒºåŸŸï¼‰
      const regionStart = 51 + Math.floor((level - 51) / 25) * 25;
      if (level === regionStart && level !== lastRegionLevel) {
        const divider = document.createElement('div');
        divider.className = 'region-divider';
        divider.textContent = getInfiniteRegionName(level) + ' âˆ';
        grid.appendChild(divider);
        lastRegionLevel = level;
      }
    }

    const btn = document.createElement('button');
    btn.className = 'level-btn';

    const isUnlocked = level <= playerProgress.currentLevel;
    const isCurrent = level === playerProgress.currentLevel;
    const stars = playerProgress.levelStars[level] || 0;
    const isBossLevel = level > BASE_LEVELS && level % 25 === 0;

    if (isCurrent) {
      btn.classList.add('current');
    } else if (isUnlocked) {
      btn.classList.add('unlocked');
    } else {
      btn.classList.add('locked');
    }

    if (isUnlocked) {
      btn.innerHTML = `
        <span class="level-num">${isBossLevel ? 'ğŸ”¥' : ''}${level}</span>
        <span class="level-stars">${getStarsDisplay(stars)}</span>
      `;
      btn.onclick = () => startLevel(level);
    } else {
      btn.innerHTML = `<span class="lock-icon">ğŸ”’</span>`;
      btn.onclick = () => showToast('è¯·å…ˆé€šå…³å‰ç½®å…³å¡');
    }

    grid.appendChild(btn);
  }

  // æ›´æ–°è¿›åº¦æ˜¾ç¤ºï¼ˆæ— é™æ¨¡å¼æ˜¾ç¤ºå·²é€šå…³æ•°ï¼‰
  document.getElementById('totalStars').textContent = playerProgress.totalStars;

  if (playerProgress.currentLevel > BASE_LEVELS) {
    // æ— é™æ¨¡å¼ï¼šæ˜¾ç¤ºå·²é€šå…³å…³å¡æ•°
    document.getElementById('progressText').textContent =
      `${playerProgress.completedLevels}å…³ âˆ`;
    document.getElementById('progressFill').style.width = '100%';
  } else {
    document.getElementById('progressText').textContent =
      `${playerProgress.completedLevels}/${BASE_LEVELS}`;
    document.getElementById('progressFill').style.width =
      `${(playerProgress.completedLevels / BASE_LEVELS) * 100}%`;
  }

  // æ»šåŠ¨åˆ°å½“å‰å…³å¡
  scrollToCurrentLevel();
}

function getStarsDisplay(stars) {
  if (stars === 0) return 'â˜†â˜†â˜†';
  if (stars === 1) return 'â­â˜†â˜†';
  if (stars === 2) return 'â­â­â˜†';
  return 'â­â­â­';
}

function scrollToCurrentLevel() {
  setTimeout(() => {
    const currentBtn = document.querySelector('.level-btn.current');
    if (currentBtn) {
      currentBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 100);
}

function startLevel(level) {
  // æ£€æŸ¥ä½“åŠ›ï¼ˆæ–°æ‰‹ä¿æŠ¤æœŸä¸æ£€æŸ¥ï¼‰
  if (level > ENERGY_CONFIG.newbieProtection && energyState.current <= 0) {
    showToast('ä½“åŠ›ä¸è¶³ï¼Œè¯·ç¨åå†è¯•');
    return;
  }

  // ä¿å­˜é€‰æ‹©çš„å…³å¡åˆ° sessionStorage
  sessionStorage.setItem('selectedLevel', level.toString());

  // è·³è½¬åˆ°æ¸¸æˆé¡µé¢
  window.location.href = 'index.html';
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// åˆå§‹åŒ–
function init() {
  loadProgress();
  loadEnergy();
  generateLevelGrid();
  updateEnergyDisplay();

  // å®šæ—¶æ›´æ–°ä½“åŠ›
  setInterval(() => {
    // è‡ªåŠ¨æ¢å¤
    if (energyState.current < ENERGY_CONFIG.max) {
      const elapsed = Date.now() - energyState.lastRegenTime;
      if (elapsed >= ENERGY_CONFIG.regenSeconds * 1000) {
        energyState.current++;
        energyState.lastRegenTime = Date.now();
      }
    }
    updateEnergyDisplay();
  }, 1000);
}

init();
</script>
</body>
</html>
